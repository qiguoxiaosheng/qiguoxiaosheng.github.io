<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>qiguoxiaosheng&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="qiguoxiaosheng&#39;s blogs">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="qiguoxiaosheng&#39;s blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="qiguoxiaosheng">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="qiguoxiaosheng&#39;s blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">qiguoxiaosheng&#39;s blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-OpenTSDB访问开启Kerberos服务的Hbase" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/" class="article-date">
  <time datetime="2020-07-23T08:47:06.854Z" itemprop="datePublished">2020-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/">OpenTSDB访问开启Kerberos服务的Hbase</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>OpenTSDB 版本：2.4.0</p>
<p>在配置文件opentsdb.conf中添加以下配置项：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------KERBEROS-----</span></span><br><span class="line"><span class="meta">hbase.security.auth.enable</span> = <span class="string">true</span></span><br><span class="line"><span class="meta">hbase.security.authentication</span> = <span class="string">kerberos</span></span><br><span class="line"><span class="meta">hbase.sasl.clientconfig</span> = <span class="string">Client</span></span><br><span class="line"><span class="comment">#principal中一定是"_HOST"，其他会有问题</span></span><br><span class="line"><span class="meta">hbase.kerberos.regionserver.principal</span> = <span class="string">hbase/_HOST@ZNV.COM</span></span><br></pre></td></tr></table></figure>

<p>在启动脚本tsdb中，未开启Kerberos时</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JVMARGS=$&#123;JVMARGS-'-enableassertions -enablesystemassertions'&#125;</span><br></pre></td></tr></table></figure>

<p>开启Kerberos</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JVMARGS=$&#123;JVMARGS-'-enableassertions -enablesystemassertions -Djava.security.auth.login.config=/opt/opentsdb-2.4.0/conf/jaas.conf -Dzookeeper.sasl.client=false -Djava.security.krb5.conf=/opt/opentsdb-2.4.0/conf/krb5.conf'&#125;</span><br></pre></td></tr></table></figure>

<p>jaas.conf文件内容</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Client</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="meta">com.sun.security.auth.module.Krb5LoginModule</span> <span class="string">required</span></span><br><span class="line">  <span class="attr">useKeyTab</span>=<span class="string">true</span></span><br><span class="line">  <span class="attr">useTicketCache</span>=<span class="string">false</span></span><br><span class="line">  <span class="attr">keyTab</span>=<span class="string">"/opt/opentsdb-2.4.0/conf/hbase.keytab"</span></span><br><span class="line">  <span class="attr">principal</span>=<span class="string">"hbase/remote.org@ZNV.COM";</span></span><br><span class="line"><span class="attr">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>其中keytab文件及本jaas.conf文件均可至Hbase服务器上安装目录下获取，CDH版中2个文件的位置为/var/run/cloudera-scm-agent/process/hbase。</p>
<p>参考资料</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/" data-id="ckd5je52e001m28p55am1ccbb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Kerberos使用记录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/" class="article-date">
  <time datetime="2020-07-22T02:35:01.046Z" itemprop="datePublished">2020-07-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">Kerberos使用记录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>新增用户</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/" data-id="ckd5je526000x28p50jyna0uc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CDH5.16启用Kerberos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/" class="article-date">
  <time datetime="2020-07-21T06:48:40.751Z" itemprop="datePublished">2020-07-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/">CDH5.16中启用Kerberos</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.在Cloudera Manager服务器上安装KDC服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install krb5-server krb5-libs krb5-auth-dialog krb5-workstation</span><br></pre></td></tr></table></figure>

<p>2.修改/etc/krb5.conf配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# vi /etc/krb5.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Configuration snippets may be placed <span class="keyword">in</span> this directory as well</span></span><br><span class="line">includedir /etc/krb5.conf.d/</span><br><span class="line"></span><br><span class="line">[logging]</span><br><span class="line"> default = FILE:/var/log/krb5libs.log</span><br><span class="line"> kdc = FILE:/var/log/krb5kdc.log</span><br><span class="line"> admin_server = FILE:/var/log/kadmind.log</span><br><span class="line"></span><br><span class="line">[libdefaults]</span><br><span class="line"> dns_lookup_realm = false</span><br><span class="line"> ticket_lifetime = 24h</span><br><span class="line"> renew_lifetime = 7d</span><br><span class="line"> forwardable = true</span><br><span class="line"> rdns = false</span><br><span class="line"> pkinit_anchors = FILE:/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line"><span class="meta">#</span><span class="bash"> default_realm = EXAMPLE.COM</span></span><br><span class="line"> default_realm = XXX.COM</span><br><span class="line"><span class="meta">#</span><span class="bash"> default_ccache_name = KEYRING:persistent:%&#123;uid&#125;</span></span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"><span class="meta">#</span><span class="bash"> EXAMPLE.COM = &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  kdc = kerberos.example.com</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  admin_server = kerberos.example.com</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;</span></span><br><span class="line"> XXX.COM = &#123;</span><br><span class="line">   kdc = hadoop1.xyd.com</span><br><span class="line">   admin_server = hadoop1.xyd.com</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">[domain_realm]</span><br><span class="line"><span class="meta">#</span><span class="bash"> .example.com = EXAMPLE.COM</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> example.com = EXAMPLE.COM</span></span><br><span class="line"> .xyd.com = XXX.COM</span><br><span class="line">  xyd.com = XXX.COM</span><br></pre></td></tr></table></figure>

<p>3.修改/var/kerberos/krb5kdc/kadm5.acl配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# more /var/kerberos/krb5kdc/kadm5.acl</span><br><span class="line">*/admin@XXX.COM *</span><br></pre></td></tr></table></figure>

<p>4.修改/var/kerberos/krb5kdc/kdc.conf配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[kdcdefaults]</span><br><span class="line"> kdc_ports = 88</span><br><span class="line"> kdc_tcp_ports = 88</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"> XXX.COM = &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">master_key_type = aes256-cts</span></span><br><span class="line">  max_renewable_life = 7d 0h 0m 0s</span><br><span class="line">  acl_file = /var/kerberos/krb5kdc/kadm5.acl</span><br><span class="line">  dict_file = /usr/share/dict/words</span><br><span class="line">  admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</span><br><span class="line">  supported_enctypes = aes256-cts:normal aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal camellia256-cts:normal camellia128-cts:normal des-hmac-sha1:normal des-cbc-md5:normal des-cbc-crc:normal</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>5.创建Kerberos数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@hadoop1 home]# sudo kdb5_util create -r XXX.COM -s</span><br><span class="line">Loading random data</span><br><span class="line">Initializing database '/var/kerberos/krb5kdc/principal' for realm 'XXX.COM',</span><br><span class="line">master key name 'K/M@XXX.COM'</span><br><span class="line">You will be prompted for the database Master Password.</span><br><span class="line">It is important that you NOT FORGET this password.</span><br><span class="line">Enter KDC database master key:</span><br><span class="line">Re-enter KDC database master key to verify:</span><br></pre></td></tr></table></figure>

<p>此处需要输入KDC数据库的密码（abc10@@@）</p>
<p>6.创建Kerberos的管理账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# sudo kadmin.local</span><br><span class="line">Authenticating as principal root/admin@XXX.COM with password.</span><br><span class="line">kadmin.local:  addprinc admin/admin@XXX.COM</span><br><span class="line">WARNING: no policy specified for admin/admin@XXX.COM; defaulting to no policy</span><br><span class="line">Enter password for principal "admin/admin@XXX.COM":</span><br><span class="line">Re-enter password for principal "admin/admin@XXX.COM":</span><br><span class="line">Principal "admin/admin@XXX.COM" created.</span><br><span class="line">kadmin.local:  exit</span><br></pre></td></tr></table></figure>

<p>kadmin.local:  addprinc admin/admin@XXX.COM</p>
<p>设置密码 abc@@@</p>
<p>7.将Kerberos服务添加到自启动服务，并启动krb5kdc和kadmin服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# sudo systemctl enable krb5kdc</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/krb5kdc.service to /usr/lib/systemd/system/krb5kdc.service.</span><br><span class="line">[root@hadoop1 home]# sudo systemctl enable kadmin</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kadmin.service to /usr/lib/systemd/system/kadmin.service.</span><br><span class="line">[root@hadoop1 home]# sudo systemctl start krb5kdc</span><br><span class="line">[root@hadoop1 home]# sudo systemctl start kadmin</span><br></pre></td></tr></table></figure>

<p>8.测试Kerberos的管理员账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# kinit admin/admin@XXX.COM</span><br><span class="line">Password for admin/admin@XXX.COM:</span><br><span class="line">[root@hadoop1 home]# klist</span><br><span class="line">Ticket cache: FILE:/tmp/krb5cc_0</span><br><span class="line">Default principal: admin/admin@hadoop1.COM</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">07/21/2020 15:34:28  07/22/2020 15:34:28  krbtgt/XXX.COM@XXX.COM</span><br><span class="line">        renew until 07/28/2020 15:34:28</span><br></pre></td></tr></table></figure>

<p>9.为集群安装所有Kerberos客户端，包括Cloudera Manager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install krb5-libs krb5-workstation</span><br></pre></td></tr></table></figure>

<p>在各个节点上执行上述语句，安装Kerberos客户端</p>
<p>10.在Cloudera Manager Server服务器上安装额外的包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install openldap-clients</span><br></pre></td></tr></table></figure>

<p>11.将KDC Server上的krb5.conf文件拷贝到所有Kerberos客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/krb5.conf root@remoteIp:/etc/</span><br></pre></td></tr></table></figure>

<p><strong>3.CDH集群启用Kerberos</strong></p>
<p>1.在KDC中给Cloudera Manager添加管理员账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# sudo kadmin.local</span><br><span class="line">Authenticating as principal root/admin@XXX.COM with password.</span><br><span class="line">kadmin.local:  addprinc cloudera-scm/admin@XXX.COM</span><br><span class="line">WARNING: no policy specified for cloudera-scm/admin@XXX.COM; defaulting to no policy</span><br><span class="line">Enter password for principal "cloudera-scm/admin@XXX.COM":</span><br><span class="line">Re-enter password for principal "cloudera-scm/admin@XXX.COM":</span><br><span class="line">Principal "cloudera-scm/admin@XXX.COM" created.</span><br><span class="line">kadmin.local:  exit</span><br></pre></td></tr></table></figure>

<p>kadmin.local:  addprinc cloudera-scm/admin@XXX.COM</p>
<p>设置密码abc@@@</p>
<p>2.进入Cloudera Manager的“管理”-&gt;“安全”界面</p>
<p>3.选择“启用Kerberos”，进入如下界面</p>
<p>4.确保如下列出的所有检查项都已完成</p>
<p>5.点击“继续”，配置相关的KDC信息，包括类型、KDC服务器、KDC Realm、加密类型以及待创建的Service Principal（hdfs，yarn,，hbase，hive等）的更新生命期等</p>
<p>6.不建议让Cloudera Manager来管理krb5.conf, 点击“继续”</p>
<p>7.输入Cloudera Manager的Kerbers管理员账号，一定得和之前创建的账号一致，点击“继续”</p>
<p>8.点击“继续”启用Kerberos</p>
<p>9.Kerberos启用完成，点击“继续”</p>
<p>10.勾选重启集群，点击“继续”</p>
<p>11.集群重启完成，点击“继续”</p>
<p>12.点击“继续”</p>
<p>点击“完成”，至此已成功启用Kerberos。</p>
<p><strong>遇到的问题</strong></p>
<p>1、NameNode无法启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PriviledgedActionException as:hdfs/xxxxa<span class="meta">@XXX</span>.COM (auth:KERBEROS) cause:org.apache.hadoop.ipc.RemoteException(javax.security.sasl.SaslException): GSS initiate failed</span><br><span class="line">Couldn<span class="string">'t setup connection for hdfs/xxxxa@XXX.COM to xxxxb/192.168.1.10:8022</span></span><br><span class="line"><span class="string">org.apache.hadoop.ipc.RemoteException(javax.security.sasl.SaslException): GSS initiate failed</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.security.SaslRpcClient.saslConnect(SaslRpcClient.java:378)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.setupSaslConnection(Client.java:594)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.access$2000(Client.java:396)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection$2.run(Client.java:761)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection$2.run(Client.java:757)</span></span><br><span class="line"><span class="string">	at java.security.AccessController.doPrivileged(Native Method)</span></span><br><span class="line"><span class="string">	at javax.security.auth.Subject.doAs(Subject.java:422)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1920)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:756)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.access$3000(Client.java:396)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client.getConnection(Client.java:1557)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client.call(Client.java:1480)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client.call(Client.java:1441)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:230)</span></span><br><span class="line"><span class="string">	at com.sun.proxy.$Proxy21.rollEditLog(Unknown Source)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.hdfs.protocolPB.NamenodeProtocolTranslatorPB.rollEditLog(NamenodeProtocolTranslatorPB.java:148)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$2.call(EditLogTailer.java:305)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$2.call(EditLogTailer.java:302)</span></span><br><span class="line"><span class="string">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span></span><br><span class="line"><span class="string">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span></span><br><span class="line"><span class="string">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span></span><br><span class="line"><span class="string">	at java.lang.Thread.run(Thread.java:745)</span></span><br></pre></td></tr></table></figure>

<p>此问题为JDK的一个BUG，需下载JCE包进行替换（路径为java_1.8/jre/lib/security/）。</p>
<p>2、Kafka Broker服务异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirement failed :inter.broker.listener.name must be a listener name defined in adverstised.listeners. the valid options based on currently configured listeners are PLAINTEXT</span><br></pre></td></tr></table></figure>

<p>原因为server.properties 中设置了重复的 adverstised.listeners 或者未设置 adverstised.listeners<br>处理方法：<br>删除重复的 adverstised.listeners 或者重新设置 adverstised.listeners</p>
<p>参考资料：</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/" data-id="ckd5je51h000028p5c09y5vyj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-浮点数存储详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-07-15T01:31:51.810Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/">浮点数存储详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>追求极致的空间利用效率<br>$$<br>2<br>$$</p>
<p>浮点数在计算机中的存储模式</p>
<p>32位</p>
<p>64位</p>
<p>规格化/非规格化</p>
<p>Java中的表示</p>
<p>舍入</p>
<p>浮点数计算</p>
<p>浮点数数据类型转换 单精度转为双精度（硬件支持，未确定具体实现细节）</p>
<p>单精度/双精度浮点数转为字符串</p>
<p>参考资料：</p>
<p><a href="https://www.h-schmidt.net/FloatConverter/IEEE754.html" target="_blank" rel="noopener">https://www.h-schmidt.net/FloatConverter/IEEE754.html</a></p>
<p><a href="https://bartaz.github.io/ieee754-visualization/" target="_blank" rel="noopener">https://bartaz.github.io/ieee754-visualization/</a></p>
<p>THE FLOATING-POINT GUIDE(<a href="https://floating-point-gui.de/references/" target="_blank" rel="noopener">https://floating-point-gui.de/references/</a> )</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/" data-id="ckd5je52h001w28p5b47a85vl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HashedWheelTimer原理解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2020-07-06T07:59:42.074Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">HashedWheelTimer原理解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" data-id="ckd5je51z000c28p5240n709v" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenTSDB之Deferred解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/06/OpenTSDB%E4%B9%8BDeferred%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2020-07-06T06:32:27.092Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/06/OpenTSDB%E4%B9%8BDeferred%E8%A7%A3%E6%9E%90/">OpenTSDB之Deferred解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在OpenTSDB源代码中，Deferred出现频率之高，让人无法忽视它的存在，也是因为它，把代码看得云里雾里，是是而非。索性专门抽出一段时间，专门研究下Deferred究竟为何高（niu）深（bi）的技术。首先找到Deferred类的的说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> A thread-safe implementation of a deferred result <span class="keyword">for</span> easy asynchronous processing.</span><br><span class="line"> This implementation is based on Twisted<span class="string">'s Python &#123;@code Deferred&#125; API.</span></span><br><span class="line"><span class="string"> *   &lt;li&gt;&lt;"http://su.pr/1PlbY7"&gt;Deferred Reference&lt;/li&gt;</span></span><br><span class="line"><span class="string"> *   &lt;li&gt;&lt;"http://su.pr/608GS1"&gt;A tutorial (Deferred in depth)&lt;/li&gt;</span></span><br><span class="line"><span class="string"> *   &lt;li&gt;&lt;"http://su.pr/2D6G9l"&gt;Source code of &#123;@code defer.py&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="string">This API is a simple and elegant way of managing asynchronous and dynamic "pipelines" (processing chains) without having to explicitly define a finite state machine.</span></span><br></pre></td></tr></table></figure>

<p>接着，顺藤摸瓜，找到了Twisted，官网资料看的一头雾水，干脆直接求助某度。以下摘录自大（网）牛（友）的总结，“Twisted is event-based, asynchronous framework ”，这个“异步”功能的代表就是 deferred。</p>
<p>deferred 的作用类似于“多线程”，负责保障多头连接、多项任务的异步执行。当然，deferred “异步”功能的实现，与多线程完全不同，具有以下特点：</p>
<p>１. deferred 产生的 event，是函数调用返回的对象；</p>
<p>２. deferred 代表一个连接任务，负责报告任务执行的延迟情况和最终结果；</p>
<p>３. 对deferred 的操作，通过预定的“事件响应器”（event handler）进行。</p>
<p>有了deferred，即可对任务的执行进行管理控制。防止程序的运行，由于等待某项任务的完成而陷入阻塞停滞，提高整体运行的效率。</p>
<p>如果编写过非阻塞网络程序的人都知道，C语言中有个函数connect, 原型是：int connect(int fd, const void *addr, int addrlen); 此函数发起一个套接字fd上的到server addr的连接。  如果fd是阻塞的，那么connect将一直阻塞直到连接成功建立或者连接失败。这个连接可能立即建立，也可能等待很久后才建立成功返回，那么程序将阻塞在这个地方，不能干其他的事情。这就是阻塞程序的缺点，但阻塞程序编程比较简单，而且在大多时候都是立即返回，所以在实际中并没有被淘汰。如果fd被设置成了非阻塞的，那么不论连接建立成功与否，connect会立即返回。如果出错或者连接已发起，但未成功，connect都会返回-1,但系统会设置errno,通过errno的值我们知道具体是出了什么错。这里我们关注的是errno的值[EINPROGRESS]，man手册是这样说的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nonblocking I/O is enabled <span class="keyword">using</span> `O_NONBLOCK`, `O_NDELAY`, <span class="keyword">or</span> `FIOSNBIO`, <span class="keyword">and</span> the connection cannot be completed immediately. This is <span class="keyword">not</span> a failure. Make the `<span class="built_in">connect</span>()` call again a few seconds later. Alternatively, wait <span class="keyword">for</span> completion by calling `select()` <span class="keyword">and</span> selecting <span class="keyword">for</span> <span class="built_in">write</span>.</span><br></pre></td></tr></table></figure>

<p>这不是一个错误，这表明连接已经发起，但还未成功。我们可以在一个时间段以后通过getsockopt检查连接是否成功，也可以通过重新调用connect，或者select的监听可写来判断监听是否成功。 这三种可以根据自己的情况选用。</p>
<p>上面说了一些题外话，但对于我们理解defer确实大大有益。因为在用twisted编写网络服务器的时候，一般都是基于单线程事件处理，那么一旦某一个连接需要大量的时间，就会影响后续的连接，从而影响了系统在单位时间的吞吐量。这些需要花费大量时间的操作一般是指磁盘IO和数据库操作。如果让他们阻塞起，会白白浪费很多cpu时间，那么我们想要的就是它能够在调用后立即返回，我们去处理其他的事情。待到IO和数据库操作完成后有一个东西来通知我们，我们再去接着处理它。这样就能大大得提高了cpu的利用率，从而在资源一定的情况下提高了服务器的性能。而我们需要的这个它，就是 twisted为我提供的defer。</p>
<p>在twisted的multi callbacks 中有下面一段话，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Multiple callbacks can be added to a Deferred. The first callback in the Deferred&#39;s callback chain will be called with the result, the second with the result of the first callback, and so on. Why do we need this? Well, consider a Deferred returned by twisted.enterprise.adbapi - the result of a SQL query. A web widget might add a callback that converts this result into HTML, and pass the Deferred onwards, where the callback will be used by twisted to return the result to the HTTP client. The callback chain will be bypassed in case of errors or exceptions.</span><br></pre></td></tr></table></figure>

<p>通过这段话我们知道，我们可以给twisted添加多个callback，而且每一个callback都是以上一个的返回结果作为传入参数被调用，这些callback会被依次调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">When the result is ready, give it to the Deferred object. .callback(result) if the operation succeeded, .errback(failure) if it failed. Note that failure is typically an instance of a twisted.python.failure.Failureinstance.</span><br><span class="line">Deferred object triggers previously-added (call&#x2F;err)back with the result or failure. Execution then follows the following rules, going down the chain of callbacks to be processed.</span><br><span class="line">Result of the callback is always passed as the first argument to the next callback, creating a chain of processors.</span><br><span class="line">If a callback raises an exception, switch to errback.</span><br><span class="line">An unhandled failure gets passed down the line of errbacks, this creating an asynchronous analog to a series to a series of except:statements.</span><br><span class="line">If an errback doesn&#39;t raise an exception or return a twisted.python.failure.Failure instance, switch to callback.</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/06/OpenTSDB%E4%B9%8BDeferred%E8%A7%A3%E6%9E%90/" data-id="ckd5je529001528p50ezi26ll" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Linux文件描述符" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/06/Linux%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/" class="article-date">
  <time datetime="2020-07-06T02:05:12.540Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/06/Linux%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/">Linux文件描述符</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Linux系统将所有设备都当作文件来处理，而Linux用文件描述符来标识每个文件对象。文件描述符是一个非负的整数，它是一个索引值，指向内核中每个进程打开文件的记录表。 它描述了数据资源，以及如何访问该资源。</p>
<p>Linux标准文件描述符</p>
<table>
<thead>
<tr>
<th>文件描述符</th>
<th>缩写</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>STDIN</td>
<td>标准输入</td>
</tr>
<tr>
<td>1</td>
<td>STDOUT</td>
<td>标准输出</td>
</tr>
<tr>
<td>2</td>
<td>STDERR</td>
<td>标准错误输出</td>
</tr>
</tbody></table>
<p>查看硬盘信息：df -m<br>查看内存信息：free -m<br>查看CPU信息：cat /proc/cpuinfo<br>查看内核所能打开的线程数：cat /proc/sys/kernel/threads-max</p>
<p>文件描述符是内核存储的文件描述符表的索引。 内核响应调用而创建文件描述符，并将文件描述符与底层文件对象的某种抽象相关联，这些对象是实际的硬件设备，文件系统或其他任何东西。 因此，引用该文件描述符的进程的读取或写入调用将由内核来索引到正确的位置。lsof(list open files)是一个列出当前系统打开文件的工具。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@local ~]# lsof -p 109110</span><br><span class="line">COMMAND    PID  USER   FD      TYPE             DEVICE  SIZE/OFF      NODE NAME</span><br><span class="line">java    109110 hbase  cwd       DIR               0,39       420  87083228 /run/cloudera-scm-agent/process/1031-hbase-MASTER</span><br><span class="line">java    109110 hbase  rtd       DIR              8,195       254       128 /</span><br><span class="line">java    109110 hbase  txt       REG              8,195      7734  33706485 /usr/java/java_1.8/bin/java</span><br><span class="line">java    109110 hbase  mem       REG              8,195    995840  50332155 /usr/lib64/libstdc++.so.6.0.19</span><br><span class="line">java    109110 hbase  mem       REG              8,198     23800  16793677 /opt/cloudera/parcels/CDH-5.15.0-1.cdh5.15.0.p0.21/lib/hadoop/lib/native/libsnappy.so.1.1.4</span><br><span class="line">java    109110 hbase  mem       REG              8,198    139608  16793668 /opt/cloudera/parcels/CDH-5.15.0-1.cdh5.15.0.p0.21/lib/hadoop/lib/native/libhadoop.so.1.0.0</span><br><span class="line">java    109110 hbase  mem       REG              8,195      7652  51793784 /usr/java/java_1.8/jre/lib/amd64/libjaas_unix.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     68192  50332271 /usr/lib64/libbz2.so.1.0.6</span><br><span class="line">java    109110 hbase  mem       REG              8,195    157424  50332265 /usr/lib64/liblzma.so.5.2.2</span><br><span class="line">java    109110 hbase  mem       REG              8,195     90248  50507691 /usr/lib64/libz.so.1.2.7</span><br><span class="line">java    109110 hbase  mem       REG              8,195     99944  50332272 /usr/lib64/libelf-0.170.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     19896  50332190 /usr/lib64/libattr.so.1.1.0</span><br><span class="line">java    109110 hbase  mem       REG              8,195     88776  50764564 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">java    109110 hbase  mem       REG              8,195    297360  50431748 /usr/lib64/libdw-0.170.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     20032  50332193 /usr/lib64/libcap.so.2.22</span><br><span class="line">java    109110 hbase  mem       REG              8,195     86544  50431750 /usr/lib64/libnss_myhostname.so.2</span><br><span class="line">java    109110 hbase  mem       REG              8,195    105824  50764592 /usr/lib64/libresolv-2.17.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     31408  50764580 /usr/lib64/libnss_dns-2.17.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     93112  51794942 /usr/java/java_1.8/jre/lib/amd64/libnio.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195    115814  51793778 /usr/java/java_1.8/jre/lib/amd64/libnet.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195    647051  92507000 /usr/java/java_1.8/jre/lib/jsse.jar</span><br><span class="line">java    109110 hbase  mem       REG              8,195     50289  51793764 /usr/java/java_1.8/jre/lib/amd64/libmanagement.so</span><br><span class="line">java    109110 hbase  mem       REG              8,198    481535 167776404 /opt/cloudera/parcels/CDH-5.15.0-1.cdh5.15.0.p0.21/jars/log4j-1.2.16.jar</span><br></pre></td></tr></table></figure>

<p>lsof输出各列信息含义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">COMMAND：进程的名称</span><br><span class="line">PID： 进程标识符</span><br><span class="line">USER：进程所有者</span><br><span class="line">FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd, rtd, txt, mem, DEL, 0u, 3w, 4r等</span><br><span class="line">TYPE：文件类型，如DIR, REG, CHR, Ipv6, unix, FIFO等</span><br><span class="line">DEVICE：指定磁盘的名称</span><br><span class="line">SIZE/OFF：文件的大小</span><br><span class="line">NODE：索引节点</span><br><span class="line">NAME：打开文件的确切名称</span><br></pre></td></tr></table></figure>

<p>FD中r表示只读，w为只写模式，u表示该文件被打开处于读写模式；大写的W表示该应用程序具有对整个文件的写锁。TYPE列文件和目录分别为REG和DIR。而CHR和BLK分别表示字符和块设备或者unix, FIFO, Ipv6分表表示UNIX域套接字，FIFO队列和IP套接字。</p>
<p>查看当前进程打开了多少文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -n|awk ‘&#123;print $2&#125;’|sort|uniq -c|sort -nr|more | grep [PID]</span><br></pre></td></tr></table></figure>

<p>查看当前进程打开文件描述符数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /proc/[PID]/fd |wc -l</span><br></pre></td></tr></table></figure>

<h3 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h3><p>查看进程允许打开的最大文件句柄数：ulimit -n。设置进程能打开的最大文件句柄数：ulimit -n xxx。</p>
<p>ulimit在系统允许的情况下，提供对特定shell可利用的资源的控制（Provides control over the resources avaliable to the shell and to processes started by it, on systems that allow such control）。-H和-S选项设定指定资源的硬限制和软限制。硬限制设定之后不能再添加，而软限制则可以增加到硬限制规定的值。如果-H和-S选项都没有指定，则软限制和硬限制同时设定。限制值可以是指定资源的数值或者hard, soft, unlimited这些特殊值，其中hard代表当前硬限制, soft代表当前软件限制, unlimited代表不限制. 如果不指定限制值, 则打印指定资源的软限制值, 除非指定了-H选项.如果指定了不只一种资源, 则限制名和单位都会在限制值前显示出来.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@local ~]# ulimit -Sn</span><br><span class="line">65536</span><br><span class="line">[root@local ~]# ulimit -Hn</span><br><span class="line">65536</span><br></pre></td></tr></table></figure>

<p>需要注意的是ulimit提供的是对特定shell可利用的资源的控制，而shell是与具体用户相关的。因此ulimit提供的是对单个用户的限制。包括以下项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@local ~]# ulimit -a</span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 766843</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 65536</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 766843</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br></pre></td></tr></table></figure>

<p>其中就有个“open files”的限制，默认是65536，也就是这个用户最大可以打开65536个文件。如果使用ulimit -n修改最大文件打开数，那么只对当前shell用户有用，同时也只对当前shell和这个shell fork出来的子shell生效，重启之后会重新恢复为默认值。</p>
<p>limits.conf</p>
<p>limits.conf这个文件是在/etc/security/目录下，因此这个文件是出于安全考虑的。limits.conf文件是用于提供对系统中的用户所使用的资源进行控制和限制，对所有用户的资源设定限制是非常重要的，这可以防止用户发起针对处理器和内存数量等的拒绝服务攻击。这些限制必须在用户登录时限制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@lv215 ~]# cat /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/security/limits.conf</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">This file sets the resource limits <span class="keyword">for</span> the users logged <span class="keyword">in</span> via PAM.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">It does not affect resource limits of the system services.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Also note that configuration files <span class="keyword">in</span> /etc/security/limits.d directory,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">which</span> are <span class="built_in">read</span> <span class="keyword">in</span> alphabetical order, override the settings <span class="keyword">in</span> this</span></span><br><span class="line"><span class="meta">#</span><span class="bash">file <span class="keyword">in</span> <span class="keyword">case</span> the domain is the same or more specific.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">That means <span class="keyword">for</span> example that setting a <span class="built_in">limit</span> <span class="keyword">for</span> wildcard domain here</span></span><br><span class="line"><span class="meta">#</span><span class="bash">can be overriden with a wildcard setting <span class="keyword">in</span> a config file <span class="keyword">in</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">subdirectory, but a user specific setting here can be overriden only</span></span><br><span class="line"><span class="meta">#</span><span class="bash">with a user specific setting <span class="keyword">in</span> the subdirectory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Each line describes a <span class="built_in">limit</span> <span class="keyword">for</span> a user <span class="keyword">in</span> the form:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;domain&gt;        &lt;<span class="built_in">type</span>&gt;  &lt;item&gt;  &lt;value&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Where:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;domain&gt; can be:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - a user name</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - a group name, with @group syntax</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - the wildcard *, <span class="keyword">for</span> default entry</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - the wildcard %, can be also used with %group syntax,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 <span class="keyword">for</span> maxlogin <span class="built_in">limit</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;<span class="built_in">type</span>&gt; can have the two values:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - <span class="string">"soft"</span> <span class="keyword">for</span> enforcing the soft limits</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - <span class="string">"hard"</span> <span class="keyword">for</span> enforcing hard limits</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;item&gt; can be one of the following:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - core - limits the core file size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - data - max data size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - fsize - maximum filesize (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - memlock - max locked-in-memory address space (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - nofile - max number of open file descriptors</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - rss - max resident <span class="built_in">set</span> size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - stack - max stack size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - cpu - max CPU time (MIN)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - nproc - max number of processes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - as - address space <span class="built_in">limit</span> (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - maxlogins - max number of logins <span class="keyword">for</span> this user</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - maxsyslogins - max number of logins on the system</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - priority - the priority to run user process with</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - locks - max number of file locks the user can hold</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - sigpending - max number of pending signals</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - msgqueue - max memory used by POSIX message queues (bytes)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - nice - max nice priority allowed to raise to values: [-20, 19]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - rtprio - max realtime priority</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;domain&gt;      &lt;<span class="built_in">type</span>&gt;  &lt;item&gt;         &lt;value&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">*               soft    core            0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">*               hard    rss             10000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@student        hard    nproc           20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@faculty        soft    nproc           20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@faculty        hard    nproc           50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ftp             hard    nproc           0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@student        -       maxlogins       4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> End of file</span></span><br><span class="line">*        hard    nofile           65536</span><br><span class="line">*        soft    nofile           65536</span><br></pre></td></tr></table></figure>

<p>其中含义如下：</p>
<ul>
<li>第一列表示域（domain）,可以使用用户名（root等），组名（以@开头）,通配置*和%，%可以用于%group参数。</li>
<li>第二列表示类型(type),值可以是soft或者hard</li>
<li>第三列表示项目(item),值可以是core, data, fsize, memlock, nofile, rss, stack, cpu, nproc, as, maxlogins, maxsyslogins, priority, locks, msgqueue, nie, rtprio。其中nofile(Number of Open File）就是文件打开数。</li>
<li>第四列表示值.</li>
</ul>
<h3 id="为什么有限制？"><a href="#为什么有限制？" class="headerlink" title="为什么有限制？"></a>为什么有限制？</h3><p>为什么Linux内核对文件句柄数、线程和进程的最大打开数进行了限制？以及如果我们把它调的太大，会产生什么样的后果？</p>
<p>原因1 - 资源问题：the operating system needs memory to manage each open file, and memory is a limited resource - especially on embedded systems.<br>原因2 - 安全问题：if there were no limits, a userland software would be able to create files endlessly until the server goes down.</p>
<p>What’s more? If the file descriptors are tcp sockets, etc, then you risk using up a large amount for the socket buffers and other kernel objects, this memory is not going to be swappable.</p>
<p>最主要的是资源问题，为防止某一单一进程打开过多文件描述符而耗尽系统资源，对进程打开文件数做了限制。</p>
<p>参考文献：</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/06/Linux%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/" data-id="ckd5je527001028p5c95zg2o2" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-入坑JavaCC" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/01/%E5%85%A5%E5%9D%91JavaCC/" class="article-date">
  <time datetime="2020-07-01T01:18:06.789Z" itemprop="datePublished">2020-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/01/%E5%85%A5%E5%9D%91JavaCC/">入坑JavaCC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/01/%E5%85%A5%E5%9D%91JavaCC/" data-id="ckd5je52g001t28p54i4cc1y5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenTSDB查询过程解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/08/OpenTSDB%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2020-06-08T09:05:11.233Z" itemprop="datePublished">2020-06-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/08/OpenTSDB%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B%E8%A7%A3%E6%9E%90/">OpenTSDB查询过程解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>OpenTSDB进行查询过程的大致步骤为：</p>
<ol>
<li>网络层收到客户端的请求，将查询条件解析成TSQuery对象；</li>
<li>调用TSQuery.buildQueries()方法或buildQueriesAsync()方法，根据TSQuery封装TSSubQuery对象创建Query对象；</li>
<li>调用Query.run()方法或者runAsync()方法，该方法完成对Hbase表额查询及查询结果的整理。</li>
</ol>
<p>其中，TSQuery.buildQueries()也是通过调用buildQueriesAsync()方法来实现的。buildQueries()处代码为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Compiles the TSQuery into an array of Query objects for execution.</span></span><br><span class="line"><span class="comment"> * If the user has not set a down sampler explicitly, and they don't want </span></span><br><span class="line"><span class="comment"> * millisecond resolution, then we set the down sampler to 1 second to handle</span></span><br><span class="line"><span class="comment"> * situations where storage may have multiple data points per second.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tsdb The tsdb to use for &#123;<span class="doctag">@link</span> TSDB#newQuery&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> A deferred array of queries to wait on for compilation.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Deferred&lt;Query[]&gt; buildQueriesAsync(<span class="keyword">final</span> TSDB tsdb) &#123;</span><br><span class="line">  <span class="comment">// 将TSSubQuery对象与解析得到的TsdbQuery对象一一对应</span></span><br><span class="line">  <span class="keyword">final</span> Query[] tsdb_queries = <span class="keyword">new</span> Query[queries.size()];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">final</span> List&lt;Deferred&lt;Object&gt;&gt; deferreds =</span><br><span class="line">      <span class="keyword">new</span> ArrayList&lt;Deferred&lt;Object&gt;&gt;(queries.size());</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; queries.size(); i++) &#123;</span><br><span class="line">    <span class="comment">// 创建TsdbQuery对象</span></span><br><span class="line">    <span class="keyword">final</span> Query query = tsdb.newQuery();</span><br><span class="line">    <span class="comment">// 初始化TsdbQuery对象</span></span><br><span class="line">    deferreds.add(query.configureFromQuery(<span class="keyword">this</span>, i));</span><br><span class="line">    tsdb_queries[i] = query;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  class GroupFinished implements Callback&lt;Query[], ArrayList&lt;Object&gt;&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Query[] call(<span class="keyword">final</span> ArrayList&lt;Object&gt; deferreds) &#123;</span><br><span class="line">      <span class="keyword">return</span> tsdb_queries;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"Query compile group callback"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> Deferred.group(deferreds).addCallback(<span class="keyword">new</span> GroupFinished());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>query.configureFromQuery()初始化TsdbQuery对象的大致过程如下：</p>
<ol>
<li>从TSQuery中查找相应的TSSubQuery对象，并根据该对象初始化TsdbQuery中的start_time，end_time，aggregator，downsampler，query_index等字段。</li>
<li>若该子查询使用tsuid进行查询，则检测tsuids字段中所有的metric是否相等</li>
<li>若该子查询未使用tsuid进行查询，则<ol>
<li>解析metric字段，获取对应的UID；</li>
<li>如果该子查询中使用了TagVFilter进行过滤，则需要解析其中涉及的tagk及tagv，获取对应的UID；</li>
<li>调用findGroupBys()方法，初始化group_bys字段及row_key_literals字段。findGroupBys()方法执行步骤如下：<ol>
<li>对TsdbQuery.filters集合按tagk进行排序；</li>
<li>迭代tagk相同的TagVFilter，记录TagVFilter.group_by字段为true的TagFilter的个数。如果此次迭代中存在的TagVLiteralOrFilter类型的TagFilter，则同时会用literals集合和literal_filters集合记录其相关信息。</li>
<li>根据步骤2中获取的信息，初始化TsdbQuery.group_bys字段及row_key_literals字段。</li>
</ol>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/08/OpenTSDB%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B%E8%A7%A3%E6%9E%90/" data-id="ckd5je52c001g28p5fks55jk2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenTSDB/" rel="tag">OpenTSDB</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-OpenTSDB数据存储" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/05/28/OpenTSDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" class="article-date">
  <time datetime="2020-05-28T06:55:15.884Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Develop/">Develop</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/05/28/OpenTSDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/">OpenTSDB源码解析--数据存储</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本小节主要记录OpenTSDB是如何存储数据的。</p>
<h4 id="rowkey"><a href="#rowkey" class="headerlink" title="rowkey"></a>rowkey</h4><table>
<thead>
<tr>
<th>salt</th>
<th>metric_uid</th>
<th>base_time</th>
<th>tagk1_uid</th>
<th>tagv1_uid</th>
<th>……</th>
<th>tagkN_uid</th>
<th>tagvN_uid</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="qualifier"><a href="#qualifier" class="headerlink" title="qualifier"></a>qualifier</h4><p>存储的时序数据的精度是秒级时，qualifier的长度为2个字节。从高位到低位来看，其中高12位 保存了从base_time开始的秒级偏移量（offset），接下来的4位是flag标志，主要用来标识该点的数据类型及所占用的字节长度。</p>
<table>
<thead>
<tr>
<th>2个字节，16位</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>offset</td>
<td>flag</td>
</tr>
<tr>
<td>12</td>
<td>4</td>
</tr>
</tbody></table>
<p>存储的时序数据的精度是毫秒时，qualifier的长度为4个字节，从高位到低位来看，高4位始终为1，用于标识其精度为毫秒级。接下来的22位保存了从base_time开始的毫秒级偏移量，随后的2位为保留位，暂无使用，最后4位为flag标识位，作用同上。</p>
<table>
<thead>
<tr>
<th>4字节，32位</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>填充1</td>
<td>offset</td>
<td>保留</td>
<td>flag</td>
</tr>
<tr>
<td>4位</td>
<td>22位</td>
<td>2位</td>
<td>4位</td>
</tr>
</tbody></table>
<p>flag 最高位表示数值的类型: 0表示整数，1表示浮点数；后三位表示值的长度：000表示1个字节，001表示2个字节，011表示4个字节，111表示8个字节。</p>
<h4 id="压缩优化"><a href="#压缩优化" class="headerlink" title="压缩优化"></a>压缩优化</h4><p>为了节省存储空间，OpenTSDB在写入时会将rowkey记录到compactionQueue中，并启动一个后台线程，定期对compactionQueue中的时序数据进行压缩，压缩的操作为将compactionQueue中同一行中不同列的数据点汇总起来，写入一个列中。具体如：</p>
<p>假设原数据为 {row1,t:05A,v1}, {row1,t:05B,v2}, {row1,t:05C,v3}，则压缩后的数据为{row1,t:05A05B05C,v1v2v3}</p>
<h4 id="追加模式"><a href="#追加模式" class="headerlink" title="追加模式"></a>追加模式</h4><p> 除了压缩优化方式外，OpenTSDB还提供了一种直接追加写入点的方式，即在写入时将同一个rowkey的数据写入一个共同的qualifier中，这样可以即可以达到压缩存储的效果，也能省去开启单独压缩线程的资源消耗。具体存储方式为{row1,t:05,Av1Bv2Cv3}，即qualifier固定，值为&lt;offset1&gt;&lt;v1&gt;&lt;offset2&gt;&lt;v2&gt;……&lt;offsetN&gt;&lt;vN&gt;。</p>
<p>但追加模式也有它的缺点，数据值保存的顺序是按写入的顺序保存的，并不能保证是按offset值排序的。</p>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p>[1] OpenTSDB技术内幕</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/05/28/OpenTSDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" data-id="ckd5je52b001f28p590bw76g0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenTSDB/" rel="tag">OpenTSDB</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Develop/">Develop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Maintenance/">Maintenance</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Test/">Test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ClickHouse/" rel="tag">ClickHouse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataX/" rel="tag">DataX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/" rel="tag">Flink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Idea/" rel="tag">Idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenTSDB/" rel="tag">OpenTSDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zeppelin/" rel="tag">Zeppelin</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ClickHouse/" style="font-size: 16.67px;">ClickHouse</a> <a href="/tags/DataX/" style="font-size: 10px;">DataX</a> <a href="/tags/Flink/" style="font-size: 13.33px;">Flink</a> <a href="/tags/Hive/" style="font-size: 10px;">Hive</a> <a href="/tags/Idea/" style="font-size: 10px;">Idea</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/OpenTSDB/" style="font-size: 20px;">OpenTSDB</a> <a href="/tags/Zeppelin/" style="font-size: 10px;">Zeppelin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/">OpenTSDB访问开启Kerberos服务的Hbase</a>
          </li>
        
          <li>
            <a href="/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">Kerberos使用记录</a>
          </li>
        
          <li>
            <a href="/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/">CDH5.16中启用Kerberos</a>
          </li>
        
          <li>
            <a href="/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/">浮点数存储详解</a>
          </li>
        
          <li>
            <a href="/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">HashedWheelTimer原理解析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 qiguoxiaosheng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>