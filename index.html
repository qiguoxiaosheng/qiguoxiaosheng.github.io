<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>qiguoxiaosheng&#39;s blogs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="qiguoxiaosheng&#39;s blogs">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="qiguoxiaosheng&#39;s blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="qiguoxiaosheng">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="qiguoxiaosheng&#39;s blogs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">qiguoxiaosheng&#39;s blogs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-OpenTSDB UID生成规则" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/30/OpenTSDB%20UID%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99/" class="article-date">
  <time datetime="2020-07-30T02:13:00.436Z" itemprop="datePublished">2020-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/30/OpenTSDB%20UID%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99/">OpenTSDB UID生成规则</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>先来看下AddDataExample.java类中，是如何获取UID的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Declare new metric</span></span><br><span class="line"> String metricName = <span class="string">"my.tsdb.test.metric"</span>;</span><br><span class="line"> <span class="comment">// First check to see it doesn't already exist</span></span><br><span class="line"> <span class="keyword">byte</span>[] byteMetricUID; <span class="comment">// we don't actually need this for the first</span></span><br><span class="line">                       <span class="comment">// .addPoint() call below.</span></span><br><span class="line"> <span class="comment">// <span class="doctag">TODO:</span> Ideally we could just call a not-yet-implemented tsdb.uIdExists()</span></span><br><span class="line"> <span class="comment">// function. </span></span><br><span class="line"> <span class="comment">// Note, however, that this is optional. If auto metric is enabled</span></span><br><span class="line"> <span class="comment">// (tsd.core.auto_create_metrics), the UID will be assigned in call to </span></span><br><span class="line"> <span class="comment">// addPoint().</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">   byteMetricUID = tsdb.getUID(UniqueIdType.METRIC, metricName);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (IllegalArgumentException iae) &#123;</span><br><span class="line">   System.out.println(<span class="string">"Metric name not valid."</span>);</span><br><span class="line">   iae.printStackTrace();</span><br><span class="line">   System.exit(<span class="number">1</span>);</span><br><span class="line"> &#125; <span class="keyword">catch</span> (NoSuchUniqueName nsune) &#123;</span><br><span class="line">   <span class="comment">// If not, great. Create it.</span></span><br><span class="line">   byteMetricUID = tsdb.assignUid(<span class="string">"metric"</span>, metricName);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>大体流程是先从缓存/Hbase中查找metric对应的UID，若不存在，则生成新的UID。从注释上了解到上述代码中的查找是非必须的，因为在TSDB.addPoint()方法中会对metric及tag是否存在UID进行判断及生成不存在的UID，具体代码部分为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Deferred&lt;Object&gt; <span class="title">addPoint</span><span class="params">(<span class="keyword">final</span> String metric,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">final</span> <span class="keyword">long</span> timestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">final</span> <span class="keyword">long</span> value,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">final</span> Map&lt;String, String&gt; tags)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">short</span> flags = (<span class="keyword">short</span>) (v.length - <span class="number">1</span>);  <span class="comment">// Just the length.</span></span><br><span class="line">  <span class="keyword">return</span> addPointInternal(metric, timestamp, v, tags, flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Deferred&lt;Object&gt; <span class="title">addPointInternal</span><span class="params">(<span class="keyword">final</span> String metric,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">long</span> timestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">byte</span>[] value,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> Map&lt;String, String&gt; tags,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">short</span> flags)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  checkTimestampAndTags(metric, timestamp, value, tags, flags);</span><br><span class="line">  <span class="comment">// 此处row = salt + metric + base_time + tagk + tagv，其中salt、base_time仅占位待填充数据</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] row = IncomingDataPoints.rowKeyTemplate(<span class="keyword">this</span>, metric, tags);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a partially initialized row key for this metric and these tags. The</span></span><br><span class="line"><span class="comment"> * only thing left to fill in is the base timestamp.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">byte</span>[] rowKeyTemplate(<span class="keyword">final</span> TSDB tsdb, <span class="keyword">final</span> String metric,</span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, String&gt; tags) &#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">short</span> metric_width = tsdb.metrics.width();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">short</span> tag_name_width = tsdb.tag_names.width();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">short</span> tag_value_width = tsdb.tag_values.width();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">short</span> num_tags = (<span class="keyword">short</span>) tags.size();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> row_size = (Const.SALT_WIDTH() + metric_width + Const.TIMESTAMP_BYTES + tag_name_width * num_tags + tag_value_width * num_tags);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] row = <span class="keyword">new</span> <span class="keyword">byte</span>[row_size];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">short</span> pos = (<span class="keyword">short</span>) Const.SALT_WIDTH();</span><br><span class="line"></span><br><span class="line">  copyInRowKey(row, pos, (tsdb.config.auto_metric() ? tsdb.metrics.getOrCreateId(metric) : tsdb.metrics.getId(metric)));</span><br><span class="line">  pos += metric_width;</span><br><span class="line"></span><br><span class="line">  pos += Const.TIMESTAMP_BYTES;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">byte</span>[] tag : Tags.resolveOrCreateAll(tsdb, tags)) &#123;</span><br><span class="line">    copyInRowKey(row, pos, tag);</span><br><span class="line">    pos += tag.length;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> row;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，两个核心方法为tsdb.metrics.getOrCreateId(metric)和Tags.resolveOrCreateAll(tsdb, tags)，分别对应metric的UID及tags的UID。</p>
<p>首先看一下getOrCreateId方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Map of pending UID assignments</span></span><br><span class="line"><span class="comment">* 记录正在分配UID的字符串，避免并发调用UniqueID方法为同一字符串分配UID出现多个UID的情况</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, Deferred&lt;<span class="keyword">byte</span>[]&gt;&gt; pending_assignments = <span class="keyword">new</span> HashMap&lt;String, Deferred&lt;<span class="keyword">byte</span>[]&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getOrCreateId(<span class="keyword">final</span> String name) <span class="keyword">throws</span> HBaseException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getIdAsync(name).joinUninterruptibly();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchUniqueName e) &#123;</span><br><span class="line">      <span class="comment">// 是否设置了UID Filter插件</span></span><br><span class="line">      <span class="keyword">if</span> (tsdb != <span class="keyword">null</span> &amp;&amp; tsdb.getUidFilter() != <span class="keyword">null</span> &amp;&amp; tsdb.getUidFilter().fillterUIDAssignments()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (!tsdb.getUidFilter().allowUIDAssignment(type, name, <span class="keyword">null</span>, <span class="keyword">null</span>).join()) &#123;</span><br><span class="line">            rejected_assignments++;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FailedToAssignUniqueIdException(<span class="keyword">new</span> String(kind), name, <span class="number">0</span>, <span class="string">"Blocked by UID filter."</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FailedToAssignUniqueIdException e1) &#123;</span><br><span class="line">          <span class="keyword">throw</span> e1;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e1) &#123;</span><br><span class="line">          LOG.error(<span class="string">"Interrupted"</span>, e1);</span><br><span class="line">          Thread.currentThread().interrupt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should never be here"</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      Deferred&lt;<span class="keyword">byte</span>[]&gt; assignment = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">boolean</span> pending = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">synchronized</span> (pending_assignments) &#123;</span><br><span class="line">        assignment = pending_assignments.get(name);</span><br><span class="line">        <span class="keyword">if</span> (assignment == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// to prevent UID leaks that can be caused when multiple time</span></span><br><span class="line">          <span class="comment">// series for the same metric or tags arrive, we need to write a </span></span><br><span class="line">          <span class="comment">// deferred to the pending map as quickly as possible. Then we can </span></span><br><span class="line">          <span class="comment">// start the assignment process after we've stashed the deferred </span></span><br><span class="line">          <span class="comment">// and released the lock</span></span><br><span class="line">          assignment = <span class="keyword">new</span> Deferred&lt;<span class="keyword">byte</span>[]&gt;();</span><br><span class="line">          pending_assignments.put(name, assignment);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          pending = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (pending) &#123;</span><br><span class="line">        LOG.info(<span class="string">"Already waiting for UID assignment: "</span> + name);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> assignment.joinUninterruptibly();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should never be here"</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// start the assignment dance after stashing the deferred</span></span><br><span class="line">      <span class="keyword">byte</span>[] uid = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        uid = <span class="keyword">new</span> UniqueIdAllocator(name, assignment).tryAllocate().joinUninterruptibly();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e1) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e1;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should never be here"</span>, e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (pending_assignments) &#123;</span><br><span class="line">          <span class="keyword">if</span> (pending_assignments.remove(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">"Completed pending assignment for: "</span> + name);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> uid;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Should never be here"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>处理的具体流程为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A[开始]</span><br><span class="line">B(从Cache&#x2F;Hbase中查询UID)</span><br><span class="line">C&#123;是否存在UID&#125;</span><br><span class="line">D&#123;是否配置了UIDFilter插件&#125;</span><br><span class="line">E&#123;校验待分配的name是否符合设定的规则&#125;</span><br><span class="line">F&#123;是否存在并发分配&#125;</span><br><span class="line">G[将待分配的name加入pending_assignments对象,调用UniqueIdAllocator类的tryAllocate方法进行生成UID]</span><br><span class="line">H[分配过程同步阻塞,是否完成分配]</span><br><span class="line">I[返回ID]</span><br><span class="line">A--&gt;B--&gt;C</span><br><span class="line">C--yes--&gt;I</span><br><span class="line">C--no--&gt;D</span><br><span class="line">D--yes--&gt;E</span><br><span class="line">D--no--&gt;I</span><br><span class="line">E--yes--&gt;F</span><br><span class="line">F--yes--&gt;H</span><br><span class="line">F--no--&gt;G</span><br><span class="line">G--&gt;H--yes--&gt;I</span><br><span class="line">style A fill:#f9f,stroke:#333,stroke-width:4px,fill-opacity:0.5</span><br></pre></td></tr></table></figure>



<p>从Cache/Hbase中查询代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; getIdAsync(<span class="keyword">final</span> String name) &#123;</span><br><span class="line">  <span class="comment">// 从缓存中查询UID</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] id = getIdFromCache(name);</span><br><span class="line">  <span class="keyword">if</span> (id != <span class="keyword">null</span>) &#123;</span><br><span class="line">    incrementCacheHits();</span><br><span class="line">    <span class="keyword">return</span> Deferred.fromResult(id);</span><br><span class="line">  &#125;</span><br><span class="line">  incrementCacheMiss();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从Hbase中查询UID，若命中，则将结果添加中缓存；否则，抛出NoSuchUniqueName异常</span></span><br><span class="line">  Deferred&lt;<span class="keyword">byte</span>[]&gt; d = getIdFromHBase(name).addCallback(<span class="keyword">new</span> GetIdCB());</span><br><span class="line">  <span class="keyword">return</span> d;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 为了便于阅读，此处调整了源码中内部类GetIdCB的位置</span></span><br><span class="line">  class GetIdCB implements Callback&lt;byte[], byte[]&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] call(<span class="keyword">final</span> <span class="keyword">byte</span>[] id) &#123;</span><br><span class="line">      <span class="keyword">if</span> (id == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchUniqueName(kind(), name);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (id.length != id_width) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Found id.length = "</span> + id.length</span><br><span class="line">                                        + <span class="string">" which is != "</span> + id_width</span><br><span class="line">                                        + <span class="string">" required for '"</span> + kind() + <span class="string">'\''</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (use_mode) &#123;</span><br><span class="line">        <span class="keyword">switch</span>(mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> READONLY:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WRITEONLY:</span><br><span class="line">          addIdToCache(name, id);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          addNameToCache(id, name);</span><br><span class="line">          addIdToCache(name, id);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addIdToCache(name, id);</span><br><span class="line">        addNameToCache(id, name);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，生成UID的重点来了，下面详细看下UniqueIdAllocator类中的tryAllocate()方法的具体实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Implements the process to allocate a new UID.</span></span><br><span class="line"><span class="comment">  * This callback is re-used multiple times in a four step process:</span></span><br><span class="line"><span class="comment">  *   1. Allocate a new UID via atomic increment.</span></span><br><span class="line"><span class="comment">  *   2. Create the reverse mapping (ID to name).</span></span><br><span class="line"><span class="comment">  *   3. Create the forward mapping (name to ID).</span></span><br><span class="line"><span class="comment">  *   4. Return the new UID to the caller.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UniqueIdAllocator</span> <span class="keyword">implements</span> <span class="title">Callback</span>&lt;<span class="title">Object</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">   ......</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> ALLOCATE_UID = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> CREATE_REVERSE_MAPPING = <span class="number">1</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> CREATE_FORWARD_MAPPING = <span class="number">2</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> DONE = <span class="number">3</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">byte</span> state = ALLOCATE_UID;  <span class="comment">// Current state of the process.</span></span><br><span class="line"></span><br><span class="line">   UniqueIdAllocator(<span class="keyword">final</span> String name, <span class="keyword">final</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; assignment) &#123;</span><br><span class="line">     <span class="keyword">this</span>.name = name;</span><br><span class="line">     <span class="keyword">this</span>.assignment = assignment;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Deferred&lt;<span class="keyword">byte</span>[]&gt; tryAllocate() &#123;</span><br><span class="line">     attempt--;</span><br><span class="line">     state = ALLOCATE_UID;</span><br><span class="line">     call(<span class="keyword">null</span>);</span><br><span class="line">     <span class="keyword">return</span> assignment;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">(<span class="keyword">final</span> Object arg)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 执行一系列的检查判断</span></span><br><span class="line">     ......</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">final</span> Deferred d;</span><br><span class="line">     <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">       <span class="keyword">case</span> ALLOCATE_UID:</span><br><span class="line">         d = allocateUid();</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> CREATE_REVERSE_MAPPING:</span><br><span class="line">         d = createReverseMapping(arg);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> CREATE_FORWARD_MAPPING:</span><br><span class="line">         d = createForwardMapping(arg);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       <span class="keyword">case</span> DONE:</span><br><span class="line">         <span class="keyword">return</span> done(arg);</span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Should never be here!"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">      <span class="comment">// pipline</span></span><br><span class="line">     <span class="keyword">return</span> d.addBoth(<span class="keyword">this</span>).addErrback(<span class="keyword">new</span> ErrBack());</span><br><span class="line">   &#125;</span><br><span class="line">  ......</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>第一步，ALLOCATE_UID</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Generates either a random or a serial ID. If random, we need to</span></span><br><span class="line"><span class="comment"> * make sure that there isn't a UID collision.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Deferred&lt;Long&gt; <span class="title">allocateUid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">"Creating "</span> + (randomize_id ? <span class="string">"a random "</span> : <span class="string">"an "</span>) + <span class="string">"ID for kind='"</span> + kind() + <span class="string">"' name='"</span> + name + <span class="string">'\''</span>);</span><br><span class="line">  <span class="comment">// 更新分配状态</span></span><br><span class="line">  state = CREATE_REVERSE_MAPPING;</span><br><span class="line">  <span class="keyword">if</span> (randomize_id) &#123;</span><br><span class="line">    <span class="comment">// 随机生成ID</span></span><br><span class="line">    <span class="keyword">return</span> Deferred.fromResult(RandomUniqueId.getRandomUID());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 自增ID</span></span><br><span class="line">    <span class="keyword">return</span> client.atomicIncrement(<span class="keyword">new</span> AtomicIncrementRequest(table, MAXID_ROW, ID_FAMILY, kind));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中随机生成的生成函数为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Use the SecureRandom class to avoid blocking calls */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SecureRandom random_generator = <span class="keyword">new</span> SecureRandom(</span><br><span class="line">    Bytes.fromLong(System.currentTimeMillis()));</span><br></pre></td></tr></table></figure>

<p>第二步，CREATE_REVERSE_MAPPING，创建从ID至Name的映射关系，先执行此步骤的原因是防止中途失败，返回一个只包含Name到ID，而无ID至Name的映射的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create the reverse mapping.</span></span><br><span class="line"><span class="comment"> * We do this before the forward one so that if we die before creating</span></span><br><span class="line"><span class="comment"> * the forward mapping we don't run the risk of "publishing" a</span></span><br><span class="line"><span class="comment"> * partially assigned ID.  The reverse mapping on its own is harmless</span></span><br><span class="line"><span class="comment"> * but the forward mapping without reverse mapping is bad as it would</span></span><br><span class="line"><span class="comment"> * point to an ID that cannot be resolved.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Deferred&lt;Boolean&gt; <span class="title">createReverseMapping</span><span class="params">(<span class="keyword">final</span> Object arg)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// arg为第一步生成的UID</span></span><br><span class="line">  <span class="keyword">if</span> (!(arg <span class="keyword">instanceof</span> Long)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Expected a Long but got "</span> + arg);</span><br><span class="line">  &#125;</span><br><span class="line">  id = (Long) arg;</span><br><span class="line">  <span class="keyword">if</span> (id &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Got a negative ID from HBase: "</span> + id);</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">"Got ID="</span> + id + <span class="string">" for kind='"</span> + kind() + <span class="string">"' name='"</span> + name + <span class="string">"'"</span>);</span><br><span class="line">  row = Bytes.fromLong(id);</span><br><span class="line">  <span class="comment">// row.length should actually be 8.</span></span><br><span class="line">  <span class="keyword">if</span> (row.length &lt; id_width) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"OMG, row.length = "</span> + row.length</span><br><span class="line">                                    + <span class="string">" which is less than "</span> + id_width</span><br><span class="line">                                    + <span class="string">" for id="</span> + id</span><br><span class="line">                                    + <span class="string">" row="</span> + Arrays.toString(row));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Verify that we're going to drop bytes that are 0.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; row.length - id_width; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (row[i] != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> String message = <span class="string">"All Unique IDs for "</span> + kind()</span><br><span class="line">        + <span class="string">" on "</span> + id_width + <span class="string">" bytes are already assigned!"</span>;</span><br><span class="line">      LOG.error(<span class="string">"OMG "</span> + message);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Shrink the ID on the requested number of bytes. 默认3个字节</span></span><br><span class="line">  row = Arrays.copyOfRange(row, row.length - id_width, row.length);</span><br><span class="line"></span><br><span class="line">  state = CREATE_FORWARD_MAPPING;</span><br><span class="line">  <span class="comment">// We are CAS'ing the KV into existence -- the second argument is how</span></span><br><span class="line">  <span class="comment">// we tell HBase we want to atomically create the KV, so that if there</span></span><br><span class="line">  <span class="comment">// is already a KV in this cell, we'll fail.  Technically we could do</span></span><br><span class="line">  <span class="comment">// just a `put' here, as we have a freshly allocated UID, so there is</span></span><br><span class="line">  <span class="comment">// not reason why a KV should already exist for this UID, but just to</span></span><br><span class="line">  <span class="comment">// err on the safe side and catch really weird corruption cases, we do</span></span><br><span class="line">  <span class="comment">// a CAS instead to create the KV.</span></span><br><span class="line">  <span class="keyword">return</span> client.compareAndSet(reverseMapping(), HBaseClient.EMPTY_ARRAY);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将id--&gt;name的映射数据写入Hbase的tsdb-uid表中</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PutRequest <span class="title">reverseMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> PutRequest(table, row, NAME_FAMILY, kind, toBytes(name));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>第三步，CREATE_FORWARD_MAPPING，将Name到ID的映射关系存入Hbase的tsdb-uid表中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Deferred&lt;?&gt; createForwardMapping(<span class="keyword">final</span> Object arg) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(arg <span class="keyword">instanceof</span> Boolean)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Expected a Boolean but got "</span> + arg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!((Boolean) arg)) &#123;  <span class="comment">// Previous CAS failed. </span></span><br><span class="line">    <span class="keyword">if</span> (randomize_id) &#123;</span><br><span class="line">      <span class="comment">// This random Id is already used by another row</span></span><br><span class="line">      LOG.warn(<span class="string">"Detected random id collision and retrying kind='"</span> + </span><br><span class="line">          kind() + <span class="string">"' name='"</span> + name + <span class="string">"'"</span>);</span><br><span class="line">      random_id_collisions++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// something is really messed up then</span></span><br><span class="line">      LOG.error(<span class="string">"WTF!  Failed to CAS reverse mapping: "</span> + reverseMapping()</span><br><span class="line">          + <span class="string">" -- run an fsck against the UID table!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    attempt--;</span><br><span class="line">    state = ALLOCATE_UID;</span><br><span class="line">    <span class="keyword">return</span> Deferred.fromResult(<span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = DONE;</span><br><span class="line">  <span class="keyword">return</span> client.compareAndSet(forwardMapping(), HBaseClient.EMPTY_ARRAY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PutRequest <span class="title">forwardMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PutRequest(table, toBytes(name), ID_FAMILY, kind, row);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第四步，DONE</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Deferred&lt;<span class="keyword">byte</span>[]&gt; done(<span class="keyword">final</span> Object arg) &#123;</span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将name--id的映射关系加入缓存</span></span><br><span class="line">  cacheMapping(name, row);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (tsdb != <span class="keyword">null</span> &amp;&amp; tsdb.getConfig().enable_realtime_uid()) &#123;</span><br><span class="line">    <span class="keyword">final</span> UIDMeta meta = <span class="keyword">new</span> UIDMeta(type, row, name);</span><br><span class="line">    meta.storeNew(tsdb);</span><br><span class="line">    LOG.info(<span class="string">"Wrote UIDMeta for: "</span> + name);</span><br><span class="line">    tsdb.indexUIDMeta(meta);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span>(pending_assignments) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pending_assignments.remove(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      LOG.info(<span class="string">"Completed pending assignment for: "</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  assignment.callback(row);</span><br><span class="line">  <span class="keyword">return</span> assignment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里记录下，为何先执行第二步（先保存id到name的映射关系），再执行第三步（保存name到id的映射关系），而不是反过来。</p>
<p>假设先执行了第三步，保存了name到id的映射关系，然后出现异常，后续操作失败，则tsdb-uid表中只保留了name到id的关系，没有保存id到name的关系。在后续查询中，使用name查询时则为此次未完全分配的UID，如果使用该UID查询name时，则会出现失败异常。而按照代码中的顺序，先保存id到name的映射关系，即使出现异常，后续通过name查询时也会重新分配UID，保证最终生成的id与name间的映射是双向的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/30/OpenTSDB%20UID%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99/" data-id="ckd8njbhs0015tsp56kf0hbow" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenTSDB Salt生成方式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/29/OpenTSDB%20Salt%E7%94%9F%E6%88%90%E6%96%B9%E5%BC%8F/" class="article-date">
  <time datetime="2020-07-29T08:20:07.226Z" itemprop="datePublished">2020-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/29/OpenTSDB%20Salt%E7%94%9F%E6%88%90%E6%96%B9%E5%BC%8F/">OpenTSDB Salt值生成方式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>废话不多说，直接上代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calculates and writes an array of one or more salt bytes at the front of</span></span><br><span class="line"><span class="comment"> * the given row key. </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * The salt is calculated by taking the Java hash code of the metric and </span></span><br><span class="line"><span class="comment"> * tag UIDs and returning a modulo based on the number of salt buckets.</span></span><br><span class="line"><span class="comment"> * The result will always be a positive integer from 0 to salt buckets.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> The row key passed in MUST have allocated the &#123;<span class="doctag">@code</span> width&#125; number of</span></span><br><span class="line"><span class="comment"> * bytes at the front of the row key or this call will overwrite data.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * WARNING: If the width is set to a positive value, then the bucket must be</span></span><br><span class="line"><span class="comment"> * at least 1 or greater.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> row_key The pre-allocated row key to write the salt to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prefixKeyWithSalt</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] row_key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Const.SALT_WIDTH() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (row_key.length &lt; (Const.SALT_WIDTH() + TSDB.metrics_width()) || </span><br><span class="line">      (Bytes.memcmp(row_key, <span class="keyword">new</span> <span class="keyword">byte</span>[Const.SALT_WIDTH() + TSDB.metrics_width()], </span><br><span class="line">          Const.SALT_WIDTH(), TSDB.metrics_width()) == <span class="number">0</span>)) &#123;</span><br><span class="line">      <span class="comment">// ^ Don't salt the global annotation row, leave it at zero</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tags_start = Const.SALT_WIDTH() + TSDB.metrics_width() +  Const.TIMESTAMP_BYTES;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// we want the metric and tags, not the timestamp</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] salt_base =  <span class="keyword">new</span> <span class="keyword">byte</span>[row_key.length - Const.SALT_WIDTH() - Const.TIMESTAMP_BYTES];</span><br><span class="line">    System.arraycopy(row_key, Const.SALT_WIDTH(), salt_base, <span class="number">0</span>, TSDB.metrics_width());</span><br><span class="line"></span><br><span class="line">    System.arraycopy(row_key, tags_start,salt_base, TSDB.metrics_width(), row_key.length - tags_start);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// salt值为abs(hashcode(metric_uid + tagk_uid + tagv_uid) % salt_buckets)</span></span><br><span class="line">    <span class="keyword">int</span> modulo = Arrays.hashCode(salt_base) % Const.SALT_BUCKETS();</span><br><span class="line">    <span class="keyword">if</span> (modulo &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// make sure we return a positive salt.</span></span><br><span class="line">      modulo = modulo * -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">// byte array storage big-edian</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] salt = getSaltBytes(modulo);</span><br><span class="line">    System.arraycopy(salt, <span class="number">0</span>, row_key, <span class="number">0</span>, Const.SALT_WIDTH());</span><br><span class="line">  &#125; <span class="comment">// else salting is disabled so it's a no-op</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键信息为：salt = hashcode(metric_uid + tagk_uid + tagv_uid) % salt_buckets</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/29/OpenTSDB%20Salt%E7%94%9F%E6%88%90%E6%96%B9%E5%BC%8F/" data-id="ckd8njbhr0012tsp52ut65aoi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenTSDB访问开启Kerberos服务的Hbase" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/" class="article-date">
  <time datetime="2020-07-23T08:47:06.854Z" itemprop="datePublished">2020-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/">OpenTSDB访问开启Kerberos服务的Hbase</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>OpenTSDB 版本：2.4.0</p>
<p>在配置文件opentsdb.conf中添加以下配置项：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------KERBEROS-----</span></span><br><span class="line"><span class="meta">hbase.security.auth.enable</span> = <span class="string">true</span></span><br><span class="line"><span class="meta">hbase.security.authentication</span> = <span class="string">kerberos</span></span><br><span class="line"><span class="meta">hbase.sasl.clientconfig</span> = <span class="string">Client</span></span><br><span class="line"><span class="comment">#principal中一定是"_HOST"，其他会有问题</span></span><br><span class="line"><span class="meta">hbase.kerberos.regionserver.principal</span> = <span class="string">hbase/_HOST@ZNV.COM</span></span><br></pre></td></tr></table></figure>

<p>在启动脚本tsdb中，未开启Kerberos时</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JVMARGS=$&#123;JVMARGS-'-enableassertions -enablesystemassertions'&#125;</span><br></pre></td></tr></table></figure>

<p>开启Kerberos</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JVMARGS=$&#123;JVMARGS-'-enableassertions -enablesystemassertions -Djava.security.auth.login.config=/opt/opentsdb-2.4.0/conf/jaas.conf -Dzookeeper.sasl.client=false -Djava.security.krb5.conf=/opt/opentsdb-2.4.0/conf/krb5.conf'&#125;</span><br></pre></td></tr></table></figure>

<p>jaas.conf文件内容</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Client</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="meta">com.sun.security.auth.module.Krb5LoginModule</span> <span class="string">required</span></span><br><span class="line">  <span class="attr">useKeyTab</span>=<span class="string">true</span></span><br><span class="line">  <span class="attr">useTicketCache</span>=<span class="string">false</span></span><br><span class="line">  <span class="attr">keyTab</span>=<span class="string">"/opt/opentsdb-2.4.0/conf/hbase.keytab"</span></span><br><span class="line">  <span class="attr">principal</span>=<span class="string">"hbase/remote.org@ZNV.COM";</span></span><br><span class="line"><span class="attr">&#125;;</span></span><br></pre></td></tr></table></figure>

<p>其中keytab文件及本jaas.conf文件均可至Hbase服务器上安装目录下获取，CDH版中2个文件的位置为/var/run/cloudera-scm-agent/process/hbase。</p>
<p>参考资料</p>
<ol>
<li><a href="https://www.jianshu.com/p/35c687e56d9f" target="_blank" rel="noopener">https://www.jianshu.com/p/35c687e56d9f</a>    “opentsdb过kerberos认证”</li>
<li><a href="https://github.com/OpenTSDB/opentsdb/issues/1062" target="_blank" rel="noopener">https://github.com/OpenTSDB/opentsdb/issues/1062</a>    “security hbase problem:Sasl initialization failed with a status of [1]: org.hbase.async.SecureRpcHelpe”</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/" data-id="ckd8njbhz001ttsp5ansi374o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Kerberos使用记录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/" class="article-date">
  <time datetime="2020-07-22T02:35:01.046Z" itemprop="datePublished">2020-07-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">Kerberos使用记录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>#kdestroy，退出当前kerberos用户，即你最后使用kinit过的那个用户</li>
<li>kadmin.local&gt;listprincs 列出所有存在数据库中的人或服务</li>
<li>kadmin.local&gt;delprinc zookeeper/hadoop01.example.org@EXAMPLE.COM 删除人或服务</li>
<li>kadmin.local&gt;addprinc admin/admin 添加人或服务</li>
<li>kadmin.local&gt;q 退出kadmin</li>
<li>kadmin: addprinc -randkey root/hadoop01.example.org@EXAMPLE.COM </li>
<li>kadmin: xst -k root.keytab root/hadoop01.example.org 导出证书</li>
<li># klist -kt root.keytab 列出这个keytab中保存的所有人或服务</li>
</ul>
<p>参考资料</p>
<p><a href="https://www.bbsmax.com/A/VGzlyYqVJb/" target="_blank" rel="noopener">https://www.bbsmax.com/A/VGzlyYqVJb/</a></p>
<p><a href="https://www.cyrusimap.org/sasl/sasl/gssapi.html" target="_blank" rel="noopener">https://www.cyrusimap.org/sasl/sasl/gssapi.html</a></p>
<p><a href="https://www.jianshu.com/p/fc2d2dbd510b" target="_blank" rel="noopener">https://www.jianshu.com/p/fc2d2dbd510b</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/" data-id="ckd8njbhp000xtsp5dlzn541c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CDH5.16启用Kerberos" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/" class="article-date">
  <time datetime="2020-07-21T06:48:40.751Z" itemprop="datePublished">2020-07-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/">CDH5.16中启用Kerberos</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.在Cloudera Manager服务器上安装KDC服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install krb5-server krb5-libs krb5-auth-dialog krb5-workstation</span><br></pre></td></tr></table></figure>

<p>2.修改/etc/krb5.conf配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# vi /etc/krb5.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Configuration snippets may be placed <span class="keyword">in</span> this directory as well</span></span><br><span class="line">includedir /etc/krb5.conf.d/</span><br><span class="line"></span><br><span class="line">[logging]</span><br><span class="line"> default = FILE:/var/log/krb5libs.log</span><br><span class="line"> kdc = FILE:/var/log/krb5kdc.log</span><br><span class="line"> admin_server = FILE:/var/log/kadmind.log</span><br><span class="line"></span><br><span class="line">[libdefaults]</span><br><span class="line"> dns_lookup_realm = false</span><br><span class="line"> ticket_lifetime = 24h</span><br><span class="line"> renew_lifetime = 7d</span><br><span class="line"> forwardable = true</span><br><span class="line"> rdns = false</span><br><span class="line"> pkinit_anchors = FILE:/etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line"><span class="meta">#</span><span class="bash"> default_realm = EXAMPLE.COM</span></span><br><span class="line"> default_realm = XXX.COM</span><br><span class="line"><span class="meta">#</span><span class="bash"> default_ccache_name = KEYRING:persistent:%&#123;uid&#125;</span></span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"><span class="meta">#</span><span class="bash"> EXAMPLE.COM = &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  kdc = kerberos.example.com</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  admin_server = kerberos.example.com</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;</span></span><br><span class="line"> XXX.COM = &#123;</span><br><span class="line">   kdc = hadoop1.xyd.com</span><br><span class="line">   admin_server = hadoop1.xyd.com</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">[domain_realm]</span><br><span class="line"><span class="meta">#</span><span class="bash"> .example.com = EXAMPLE.COM</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> example.com = EXAMPLE.COM</span></span><br><span class="line"> .xyd.com = XXX.COM</span><br><span class="line">  xyd.com = XXX.COM</span><br></pre></td></tr></table></figure>

<p>3.修改/var/kerberos/krb5kdc/kadm5.acl配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# more /var/kerberos/krb5kdc/kadm5.acl</span><br><span class="line">*/admin@XXX.COM *</span><br></pre></td></tr></table></figure>

<p>4.修改/var/kerberos/krb5kdc/kdc.conf配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[kdcdefaults]</span><br><span class="line"> kdc_ports = 88</span><br><span class="line"> kdc_tcp_ports = 88</span><br><span class="line"></span><br><span class="line">[realms]</span><br><span class="line"> XXX.COM = &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash">master_key_type = aes256-cts</span></span><br><span class="line">  max_renewable_life = 7d 0h 0m 0s</span><br><span class="line">  acl_file = /var/kerberos/krb5kdc/kadm5.acl</span><br><span class="line">  dict_file = /usr/share/dict/words</span><br><span class="line">  admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</span><br><span class="line">  supported_enctypes = aes256-cts:normal aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal camellia256-cts:normal camellia128-cts:normal des-hmac-sha1:normal des-cbc-md5:normal des-cbc-crc:normal</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>5.创建Kerberos数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@hadoop1 home]# sudo kdb5_util create -r XXX.COM -s</span><br><span class="line">Loading random data</span><br><span class="line">Initializing database '/var/kerberos/krb5kdc/principal' for realm 'XXX.COM',</span><br><span class="line">master key name 'K/M@XXX.COM'</span><br><span class="line">You will be prompted for the database Master Password.</span><br><span class="line">It is important that you NOT FORGET this password.</span><br><span class="line">Enter KDC database master key:</span><br><span class="line">Re-enter KDC database master key to verify:</span><br></pre></td></tr></table></figure>

<p>此处需要输入KDC数据库的密码（abc10@@@）</p>
<p>6.创建Kerberos的管理账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# sudo kadmin.local</span><br><span class="line">Authenticating as principal root/admin@XXX.COM with password.</span><br><span class="line">kadmin.local:  addprinc admin/admin@XXX.COM</span><br><span class="line">WARNING: no policy specified for admin/admin@XXX.COM; defaulting to no policy</span><br><span class="line">Enter password for principal "admin/admin@XXX.COM":</span><br><span class="line">Re-enter password for principal "admin/admin@XXX.COM":</span><br><span class="line">Principal "admin/admin@XXX.COM" created.</span><br><span class="line">kadmin.local:  exit</span><br></pre></td></tr></table></figure>

<p>kadmin.local:  addprinc admin/admin@XXX.COM</p>
<p>设置密码 abc@@@</p>
<p>7.将Kerberos服务添加到自启动服务，并启动krb5kdc和kadmin服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# sudo systemctl enable krb5kdc</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/krb5kdc.service to /usr/lib/systemd/system/krb5kdc.service.</span><br><span class="line">[root@hadoop1 home]# sudo systemctl enable kadmin</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kadmin.service to /usr/lib/systemd/system/kadmin.service.</span><br><span class="line">[root@hadoop1 home]# sudo systemctl start krb5kdc</span><br><span class="line">[root@hadoop1 home]# sudo systemctl start kadmin</span><br></pre></td></tr></table></figure>

<p>8.测试Kerberos的管理员账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# kinit admin/admin@XXX.COM</span><br><span class="line">Password for admin/admin@XXX.COM:</span><br><span class="line">[root@hadoop1 home]# klist</span><br><span class="line">Ticket cache: FILE:/tmp/krb5cc_0</span><br><span class="line">Default principal: admin/admin@hadoop1.COM</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">07/21/2020 15:34:28  07/22/2020 15:34:28  krbtgt/XXX.COM@XXX.COM</span><br><span class="line">        renew until 07/28/2020 15:34:28</span><br></pre></td></tr></table></figure>

<p>9.为集群安装所有Kerberos客户端，包括Cloudera Manager</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install krb5-libs krb5-workstation</span><br></pre></td></tr></table></figure>

<p>在各个节点上执行上述语句，安装Kerberos客户端</p>
<p>10.在Cloudera Manager Server服务器上安装额外的包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install openldap-clients</span><br></pre></td></tr></table></figure>

<p>11.将KDC Server上的krb5.conf文件拷贝到所有Kerberos客户端</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /etc/krb5.conf root@remoteIp:/etc/</span><br></pre></td></tr></table></figure>

<p><strong>3.CDH集群启用Kerberos</strong></p>
<p>1.在KDC中给Cloudera Manager添加管理员账号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hadoop1 home]# sudo kadmin.local</span><br><span class="line">Authenticating as principal root/admin@XXX.COM with password.</span><br><span class="line">kadmin.local:  addprinc cloudera-scm/admin@XXX.COM</span><br><span class="line">WARNING: no policy specified for cloudera-scm/admin@XXX.COM; defaulting to no policy</span><br><span class="line">Enter password for principal "cloudera-scm/admin@XXX.COM":</span><br><span class="line">Re-enter password for principal "cloudera-scm/admin@XXX.COM":</span><br><span class="line">Principal "cloudera-scm/admin@XXX.COM" created.</span><br><span class="line">kadmin.local:  exit</span><br></pre></td></tr></table></figure>

<p>kadmin.local:  addprinc cloudera-scm/admin@XXX.COM</p>
<p>设置密码abc@@@</p>
<p>2.进入Cloudera Manager的“管理”-&gt;“安全”界面</p>
<p>3.选择“启用Kerberos”，进入如下界面</p>
<p>4.确保如下列出的所有检查项都已完成</p>
<p>5.点击“继续”，配置相关的KDC信息，包括类型、KDC服务器、KDC Realm、加密类型以及待创建的Service Principal（hdfs，yarn,，hbase，hive等）的更新生命期等</p>
<p>6.不建议让Cloudera Manager来管理krb5.conf, 点击“继续”</p>
<p>7.输入Cloudera Manager的Kerbers管理员账号，一定得和之前创建的账号一致，点击“继续”</p>
<p>8.点击“继续”启用Kerberos</p>
<p>9.Kerberos启用完成，点击“继续”</p>
<p>10.勾选重启集群，点击“继续”</p>
<p>11.集群重启完成，点击“继续”</p>
<p>12.点击“继续”</p>
<p>点击“完成”，至此已成功启用Kerberos。</p>
<p><strong>遇到的问题</strong></p>
<p>1、NameNode无法启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PriviledgedActionException as:hdfs/xxxxa<span class="meta">@XXX</span>.COM (auth:KERBEROS) cause:org.apache.hadoop.ipc.RemoteException(javax.security.sasl.SaslException): GSS initiate failed</span><br><span class="line">Couldn<span class="string">'t setup connection for hdfs/xxxxa@XXX.COM to xxxxb/192.168.1.10:8022</span></span><br><span class="line"><span class="string">org.apache.hadoop.ipc.RemoteException(javax.security.sasl.SaslException): GSS initiate failed</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.security.SaslRpcClient.saslConnect(SaslRpcClient.java:378)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.setupSaslConnection(Client.java:594)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.access$2000(Client.java:396)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection$2.run(Client.java:761)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection$2.run(Client.java:757)</span></span><br><span class="line"><span class="string">	at java.security.AccessController.doPrivileged(Native Method)</span></span><br><span class="line"><span class="string">	at javax.security.auth.Subject.doAs(Subject.java:422)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1920)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:756)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client$Connection.access$3000(Client.java:396)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client.getConnection(Client.java:1557)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client.call(Client.java:1480)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.Client.call(Client.java:1441)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:230)</span></span><br><span class="line"><span class="string">	at com.sun.proxy.$Proxy21.rollEditLog(Unknown Source)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.hdfs.protocolPB.NamenodeProtocolTranslatorPB.rollEditLog(NamenodeProtocolTranslatorPB.java:148)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$2.call(EditLogTailer.java:305)</span></span><br><span class="line"><span class="string">	at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$2.call(EditLogTailer.java:302)</span></span><br><span class="line"><span class="string">	at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span></span><br><span class="line"><span class="string">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span></span><br><span class="line"><span class="string">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span></span><br><span class="line"><span class="string">	at java.lang.Thread.run(Thread.java:745)</span></span><br></pre></td></tr></table></figure>

<p>此问题为JDK的一个BUG，需下载JCE包进行替换（路径为java_1.8/jre/lib/security/）。</p>
<p>2、Kafka Broker服务异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirement failed :inter.broker.listener.name must be a listener name defined in adverstised.listeners. the valid options based on currently configured listeners are PLAINTEXT</span><br></pre></td></tr></table></figure>

<p>原因为server.properties 中设置了重复的 adverstised.listeners 或者未设置 adverstised.listeners<br>处理方法：<br>删除重复的 adverstised.listeners 或者重新设置 adverstised.listeners</p>
<p>参考资料：</p>
<ol>
<li><a href="https://cloud.tencent.com/developer/article/1078812" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1078812</a>    “如何在Redhat7.3的CDH5.14中启用Kerberos”</li>
<li><a href="https://docs.cloudera.com/documentation/enterprise/latest/topics/cm_sg_s4_kerb_wizard.html#concept_ssg_x5y_l4" target="_blank" rel="noopener">https://docs.cloudera.com/documentation/enterprise/latest/topics/cm_sg_s4_kerb_wizard.html#concept_ssg_x5y_l4</a></li>
<li><a href="https://blog.csdn.net/qq_24651739/article/details/103398491" target="_blank" rel="noopener">https://blog.csdn.net/qq_24651739/article/details/103398491</a>    “org.apache.hadoop.ipc.RemoteException(javax.securi ty.sasl.SaslException): GSS initiate failed”</li>
<li><a href="https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.0/installing-ranger/content/kerberos_installing_the_jce.html" target="_blank" rel="noopener">https://docs.cloudera.com/HDPDocuments/HDP3/HDP-3.1.0/installing-ranger/content/kerberos_installing_the_jce.html</a>    “Install the JCE for Kerberos”</li>
<li><a href="https://blog.csdn.net/zsyoung/article/details/100102551" target="_blank" rel="noopener">https://blog.csdn.net/zsyoung/article/details/100102551</a>    “kafka 配置 kerberos 中遇到的问题”</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/" data-id="ckd8njbh10000tsp597br1f9t" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-浮点数存储详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-07-15T01:31:51.810Z" itemprop="datePublished">2020-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/">浮点数存储详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>追求极致的空间利用效率<br>$$<br>2<br>$$</p>
<p>浮点数在计算机中的存储模式</p>
<p>32位</p>
<p>64位</p>
<p>规格化/非规格化</p>
<p>Java中的表示</p>
<p>舍入</p>
<p>浮点数计算</p>
<p>浮点数数据类型转换 单精度转为双精度（硬件支持，未确定具体实现细节）</p>
<p>单精度/双精度浮点数转为字符串</p>
<p>参考资料：</p>
<ol>
<li><a href="https://www.h-schmidt.net/FloatConverter/IEEE754.html" target="_blank" rel="noopener">https://www.h-schmidt.net/FloatConverter/IEEE754.html</a></li>
<li><a href="https://bartaz.github.io/ieee754-visualization/" target="_blank" rel="noopener">https://bartaz.github.io/ieee754-visualization/</a></li>
<li><a href="https://floating-point-gui.de/references/" target="_blank" rel="noopener">https://floating-point-gui.de/references/</a> THE FLOATING-POINT GUIDE</li>
<li><a href="https://zhuanlan.zhihu.com/p/61442236" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/61442236</a> 走进 JDK 之 Float</li>
<li><a href="https://stackoverflow.com/questions/11772776/how-are-double-precision-floating-point-numbers-converted-to-single-precision-fl" target="_blank" rel="noopener">https://stackoverflow.com/questions/11772776/how-are-double-precision-floating-point-numbers-converted-to-single-precision-fl</a></li>
<li><a href="https://stackoverflow.com/questions/33652466/what-is-the-definition-of-convert-single-precision-to-double-precision-floating" target="_blank" rel="noopener">https://stackoverflow.com/questions/33652466/what-is-the-definition-of-convert-single-precision-to-double-precision-floating</a></li>
<li><a href="https://www.wikihow.com/Convert-a-Number-from-Decimal-to-IEEE-754-Floating-Point-Representation" target="_blank" rel="noopener">https://www.wikihow.com/Convert-a-Number-from-Decimal-to-IEEE-754-Floating-Point-Representation</a></li>
<li><a href="https://www.felixcloutier.com/x86/cvtss2sd" target="_blank" rel="noopener">https://www.felixcloutier.com/x86/cvtss2sd</a></li>
<li>“深入理解计算机系统（第三版）2.4/3.11”</li>
<li><a href="https://ieeexplore.ieee.org/document/8766229/metrics#metrics" target="_blank" rel="noopener">https://ieeexplore.ieee.org/document/8766229/metrics#metrics</a> “754-2019 - IEEE Standard for Floating-Point Arithmetic”</li>
<li><a href="https://hg.openjdk.java.net/jdk8/jdk8/jdk/shortlog/687fd7c7986d" target="_blank" rel="noopener">https://hg.openjdk.java.net/jdk8/jdk8/jdk/shortlog/687fd7c7986d</a> “openjdk”</li>
<li><a href="https://github.com/openjdk/jdk" target="_blank" rel="noopener">https://github.com/openjdk/jdk</a></li>
<li><a href="http://www.matools.com/api/java8" target="_blank" rel="noopener">http://www.matools.com/api/java8</a> “java在线API”</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/15/%E6%B5%AE%E7%82%B9%E6%95%B0%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3/" data-id="ckd8njbi1001ztsp50h31aa7s" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HashedWheelTimer原理解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2020-07-06T07:59:42.074Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">HashedWheelTimer原理解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/06/HashedWheelTimer%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" data-id="ckd8njbhk000gtsp5aqci0ovg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-OpenTSDB之Deferred解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/06/OpenTSDB%E4%B9%8BDeferred%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2020-07-06T06:32:27.092Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/06/OpenTSDB%E4%B9%8BDeferred%E8%A7%A3%E6%9E%90/">OpenTSDB之Deferred解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在OpenTSDB源代码中，Deferred出现频率之高，让人无法忽视它的存在，也是因为它，把代码看得云里雾里，是是而非。索性专门抽出一段时间，专门研究下Deferred究竟为何高（niu）深（bi）的技术。首先找到Deferred类的的说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> A thread-safe implementation of a deferred result <span class="keyword">for</span> easy asynchronous processing.</span><br><span class="line"> This implementation is based on Twisted<span class="string">'s Python &#123;@code Deferred&#125; API.</span></span><br><span class="line"><span class="string"> *   &lt;li&gt;&lt;"http://su.pr/1PlbY7"&gt;Deferred Reference&lt;/li&gt;</span></span><br><span class="line"><span class="string"> *   &lt;li&gt;&lt;"http://su.pr/608GS1"&gt;A tutorial (Deferred in depth)&lt;/li&gt;</span></span><br><span class="line"><span class="string"> *   &lt;li&gt;&lt;"http://su.pr/2D6G9l"&gt;Source code of &#123;@code defer.py&#125;&lt;/li&gt;</span></span><br><span class="line"><span class="string">This API is a simple and elegant way of managing asynchronous and dynamic "pipelines" (processing chains) without having to explicitly define a finite state machine.</span></span><br></pre></td></tr></table></figure>

<p>接着，顺藤摸瓜，找到了Twisted，官网资料看的一头雾水，干脆直接求助某度。以下摘录自大（网）牛（友）的总结，“Twisted is event-based, asynchronous framework ”，这个“异步”功能的代表就是 deferred。</p>
<p>deferred 的作用类似于“多线程”，负责保障多头连接、多项任务的异步执行。当然，deferred “异步”功能的实现，与多线程完全不同，具有以下特点：</p>
<p>１. deferred 产生的 event，是函数调用返回的对象；</p>
<p>２. deferred 代表一个连接任务，负责报告任务执行的延迟情况和最终结果；</p>
<p>３. 对deferred 的操作，通过预定的“事件响应器”（event handler）进行。</p>
<p>有了deferred，即可对任务的执行进行管理控制。防止程序的运行，由于等待某项任务的完成而陷入阻塞停滞，提高整体运行的效率。</p>
<p>如果编写过非阻塞网络程序的人都知道，C语言中有个函数connect, 原型是：int connect(int fd, const void *addr, int addrlen); 此函数发起一个套接字fd上的到server addr的连接。  如果fd是阻塞的，那么connect将一直阻塞直到连接成功建立或者连接失败。这个连接可能立即建立，也可能等待很久后才建立成功返回，那么程序将阻塞在这个地方，不能干其他的事情。这就是阻塞程序的缺点，但阻塞程序编程比较简单，而且在大多时候都是立即返回，所以在实际中并没有被淘汰。如果fd被设置成了非阻塞的，那么不论连接建立成功与否，connect会立即返回。如果出错或者连接已发起，但未成功，connect都会返回-1,但系统会设置errno,通过errno的值我们知道具体是出了什么错。这里我们关注的是errno的值[EINPROGRESS]，man手册是这样说的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nonblocking I/O is enabled <span class="keyword">using</span> `O_NONBLOCK`, `O_NDELAY`, <span class="keyword">or</span> `FIOSNBIO`, <span class="keyword">and</span> the connection cannot be completed immediately. This is <span class="keyword">not</span> a failure. Make the `<span class="built_in">connect</span>()` call again a few seconds later. Alternatively, wait <span class="keyword">for</span> completion by calling `select()` <span class="keyword">and</span> selecting <span class="keyword">for</span> <span class="built_in">write</span>.</span><br></pre></td></tr></table></figure>

<p>这不是一个错误，这表明连接已经发起，但还未成功。我们可以在一个时间段以后通过getsockopt检查连接是否成功，也可以通过重新调用connect，或者select的监听可写来判断监听是否成功。 这三种可以根据自己的情况选用。</p>
<p>上面说了一些题外话，但对于我们理解defer确实大大有益。因为在用twisted编写网络服务器的时候，一般都是基于单线程事件处理，那么一旦某一个连接需要大量的时间，就会影响后续的连接，从而影响了系统在单位时间的吞吐量。这些需要花费大量时间的操作一般是指磁盘IO和数据库操作。如果让他们阻塞起，会白白浪费很多cpu时间，那么我们想要的就是它能够在调用后立即返回，我们去处理其他的事情。待到IO和数据库操作完成后有一个东西来通知我们，我们再去接着处理它。这样就能大大得提高了cpu的利用率，从而在资源一定的情况下提高了服务器的性能。而我们需要的这个它，就是 twisted为我提供的defer。</p>
<p>在twisted的multi callbacks 中有下面一段话，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Multiple callbacks can be added to a Deferred. The first callback in the Deferred&#39;s callback chain will be called with the result, the second with the result of the first callback, and so on. Why do we need this? Well, consider a Deferred returned by twisted.enterprise.adbapi - the result of a SQL query. A web widget might add a callback that converts this result into HTML, and pass the Deferred onwards, where the callback will be used by twisted to return the result to the HTTP client. The callback chain will be bypassed in case of errors or exceptions.</span><br></pre></td></tr></table></figure>

<p>通过这段话我们知道，我们可以给twisted添加多个callback，而且每一个callback都是以上一个的返回结果作为传入参数被调用，这些callback会被依次调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">When the result is ready, give it to the Deferred object. .callback(result) if the operation succeeded, .errback(failure) if it failed. Note that failure is typically an instance of a twisted.python.failure.Failureinstance.</span><br><span class="line">Deferred object triggers previously-added (call&#x2F;err)back with the result or failure. Execution then follows the following rules, going down the chain of callbacks to be processed.</span><br><span class="line">Result of the callback is always passed as the first argument to the next callback, creating a chain of processors.</span><br><span class="line">If a callback raises an exception, switch to errback.</span><br><span class="line">An unhandled failure gets passed down the line of errbacks, this creating an asynchronous analog to a series to a series of except:statements.</span><br><span class="line">If an errback doesn&#39;t raise an exception or return a twisted.python.failure.Failure instance, switch to callback.</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/06/OpenTSDB%E4%B9%8BDeferred%E8%A7%A3%E6%9E%90/" data-id="ckd8njbht001ctsp5bikd1gqt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Linux文件描述符" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/06/Linux%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/" class="article-date">
  <time datetime="2020-07-06T02:05:12.540Z" itemprop="datePublished">2020-07-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/06/Linux%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/">Linux文件描述符</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Linux系统将所有设备都当作文件来处理，而Linux用文件描述符来标识每个文件对象。文件描述符是一个非负的整数，它是一个索引值，指向内核中每个进程打开文件的记录表。 它描述了数据资源，以及如何访问该资源。</p>
<p>Linux标准文件描述符</p>
<table>
<thead>
<tr>
<th>文件描述符</th>
<th>缩写</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>STDIN</td>
<td>标准输入</td>
</tr>
<tr>
<td>1</td>
<td>STDOUT</td>
<td>标准输出</td>
</tr>
<tr>
<td>2</td>
<td>STDERR</td>
<td>标准错误输出</td>
</tr>
</tbody></table>
<p>查看硬盘信息：df -m<br>查看内存信息：free -m<br>查看CPU信息：cat /proc/cpuinfo<br>查看内核所能打开的线程数：cat /proc/sys/kernel/threads-max</p>
<p>文件描述符是内核存储的文件描述符表的索引。 内核响应调用而创建文件描述符，并将文件描述符与底层文件对象的某种抽象相关联，这些对象是实际的硬件设备，文件系统或其他任何东西。 因此，引用该文件描述符的进程的读取或写入调用将由内核来索引到正确的位置。lsof(list open files)是一个列出当前系统打开文件的工具。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@local ~]# lsof -p 109110</span><br><span class="line">COMMAND    PID  USER   FD      TYPE             DEVICE  SIZE/OFF      NODE NAME</span><br><span class="line">java    109110 hbase  cwd       DIR               0,39       420  87083228 /run/cloudera-scm-agent/process/1031-hbase-MASTER</span><br><span class="line">java    109110 hbase  rtd       DIR              8,195       254       128 /</span><br><span class="line">java    109110 hbase  txt       REG              8,195      7734  33706485 /usr/java/java_1.8/bin/java</span><br><span class="line">java    109110 hbase  mem       REG              8,195    995840  50332155 /usr/lib64/libstdc++.so.6.0.19</span><br><span class="line">java    109110 hbase  mem       REG              8,198     23800  16793677 /opt/cloudera/parcels/CDH-5.15.0-1.cdh5.15.0.p0.21/lib/hadoop/lib/native/libsnappy.so.1.1.4</span><br><span class="line">java    109110 hbase  mem       REG              8,198    139608  16793668 /opt/cloudera/parcels/CDH-5.15.0-1.cdh5.15.0.p0.21/lib/hadoop/lib/native/libhadoop.so.1.0.0</span><br><span class="line">java    109110 hbase  mem       REG              8,195      7652  51793784 /usr/java/java_1.8/jre/lib/amd64/libjaas_unix.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     68192  50332271 /usr/lib64/libbz2.so.1.0.6</span><br><span class="line">java    109110 hbase  mem       REG              8,195    157424  50332265 /usr/lib64/liblzma.so.5.2.2</span><br><span class="line">java    109110 hbase  mem       REG              8,195     90248  50507691 /usr/lib64/libz.so.1.2.7</span><br><span class="line">java    109110 hbase  mem       REG              8,195     99944  50332272 /usr/lib64/libelf-0.170.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     19896  50332190 /usr/lib64/libattr.so.1.1.0</span><br><span class="line">java    109110 hbase  mem       REG              8,195     88776  50764564 /usr/lib64/libgcc_s-4.8.5-20150702.so.1</span><br><span class="line">java    109110 hbase  mem       REG              8,195    297360  50431748 /usr/lib64/libdw-0.170.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     20032  50332193 /usr/lib64/libcap.so.2.22</span><br><span class="line">java    109110 hbase  mem       REG              8,195     86544  50431750 /usr/lib64/libnss_myhostname.so.2</span><br><span class="line">java    109110 hbase  mem       REG              8,195    105824  50764592 /usr/lib64/libresolv-2.17.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     31408  50764580 /usr/lib64/libnss_dns-2.17.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195     93112  51794942 /usr/java/java_1.8/jre/lib/amd64/libnio.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195    115814  51793778 /usr/java/java_1.8/jre/lib/amd64/libnet.so</span><br><span class="line">java    109110 hbase  mem       REG              8,195    647051  92507000 /usr/java/java_1.8/jre/lib/jsse.jar</span><br><span class="line">java    109110 hbase  mem       REG              8,195     50289  51793764 /usr/java/java_1.8/jre/lib/amd64/libmanagement.so</span><br><span class="line">java    109110 hbase  mem       REG              8,198    481535 167776404 /opt/cloudera/parcels/CDH-5.15.0-1.cdh5.15.0.p0.21/jars/log4j-1.2.16.jar</span><br></pre></td></tr></table></figure>

<p>lsof输出各列信息含义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">COMMAND：进程的名称</span><br><span class="line">PID： 进程标识符</span><br><span class="line">USER：进程所有者</span><br><span class="line">FD：文件描述符，应用程序通过文件描述符识别该文件。如cwd, rtd, txt, mem, DEL, 0u, 3w, 4r等</span><br><span class="line">TYPE：文件类型，如DIR, REG, CHR, Ipv6, unix, FIFO等</span><br><span class="line">DEVICE：指定磁盘的名称</span><br><span class="line">SIZE/OFF：文件的大小</span><br><span class="line">NODE：索引节点</span><br><span class="line">NAME：打开文件的确切名称</span><br></pre></td></tr></table></figure>

<p>FD中r表示只读，w为只写模式，u表示该文件被打开处于读写模式；大写的W表示该应用程序具有对整个文件的写锁。TYPE列文件和目录分别为REG和DIR。而CHR和BLK分别表示字符和块设备或者unix, FIFO, Ipv6分表表示UNIX域套接字，FIFO队列和IP套接字。</p>
<p>查看当前进程打开了多少文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -n|awk ‘&#123;print $2&#125;’|sort|uniq -c|sort -nr|more | grep [PID]</span><br></pre></td></tr></table></figure>

<p>查看当前进程打开文件描述符数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /proc/[PID]/fd |wc -l</span><br></pre></td></tr></table></figure>

<h3 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h3><p>查看进程允许打开的最大文件句柄数：ulimit -n。设置进程能打开的最大文件句柄数：ulimit -n xxx。</p>
<p>ulimit在系统允许的情况下，提供对特定shell可利用的资源的控制（Provides control over the resources avaliable to the shell and to processes started by it, on systems that allow such control）。-H和-S选项设定指定资源的硬限制和软限制。硬限制设定之后不能再添加，而软限制则可以增加到硬限制规定的值。如果-H和-S选项都没有指定，则软限制和硬限制同时设定。限制值可以是指定资源的数值或者hard, soft, unlimited这些特殊值，其中hard代表当前硬限制, soft代表当前软件限制, unlimited代表不限制. 如果不指定限制值, 则打印指定资源的软限制值, 除非指定了-H选项.如果指定了不只一种资源, 则限制名和单位都会在限制值前显示出来.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@local ~]# ulimit -Sn</span><br><span class="line">65536</span><br><span class="line">[root@local ~]# ulimit -Hn</span><br><span class="line">65536</span><br></pre></td></tr></table></figure>

<p>需要注意的是ulimit提供的是对特定shell可利用的资源的控制，而shell是与具体用户相关的。因此ulimit提供的是对单个用户的限制。包括以下项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@local ~]# ulimit -a</span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 766843</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 65536</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 766843</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br></pre></td></tr></table></figure>

<p>其中就有个“open files”的限制，默认是65536，也就是这个用户最大可以打开65536个文件。如果使用ulimit -n修改最大文件打开数，那么只对当前shell用户有用，同时也只对当前shell和这个shell fork出来的子shell生效，重启之后会重新恢复为默认值。</p>
<p>limits.conf</p>
<p>limits.conf这个文件是在/etc/security/目录下，因此这个文件是出于安全考虑的。limits.conf文件是用于提供对系统中的用户所使用的资源进行控制和限制，对所有用户的资源设定限制是非常重要的，这可以防止用户发起针对处理器和内存数量等的拒绝服务攻击。这些限制必须在用户登录时限制。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@lv215 ~]# cat /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> /etc/security/limits.conf</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">This file sets the resource limits <span class="keyword">for</span> the users logged <span class="keyword">in</span> via PAM.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">It does not affect resource limits of the system services.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Also note that configuration files <span class="keyword">in</span> /etc/security/limits.d directory,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">which</span> are <span class="built_in">read</span> <span class="keyword">in</span> alphabetical order, override the settings <span class="keyword">in</span> this</span></span><br><span class="line"><span class="meta">#</span><span class="bash">file <span class="keyword">in</span> <span class="keyword">case</span> the domain is the same or more specific.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">That means <span class="keyword">for</span> example that setting a <span class="built_in">limit</span> <span class="keyword">for</span> wildcard domain here</span></span><br><span class="line"><span class="meta">#</span><span class="bash">can be overriden with a wildcard setting <span class="keyword">in</span> a config file <span class="keyword">in</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash">subdirectory, but a user specific setting here can be overriden only</span></span><br><span class="line"><span class="meta">#</span><span class="bash">with a user specific setting <span class="keyword">in</span> the subdirectory.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Each line describes a <span class="built_in">limit</span> <span class="keyword">for</span> a user <span class="keyword">in</span> the form:</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;domain&gt;        &lt;<span class="built_in">type</span>&gt;  &lt;item&gt;  &lt;value&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Where:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;domain&gt; can be:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - a user name</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - a group name, with @group syntax</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - the wildcard *, <span class="keyword">for</span> default entry</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - the wildcard %, can be also used with %group syntax,</span></span><br><span class="line"><span class="meta">#</span><span class="bash">                 <span class="keyword">for</span> maxlogin <span class="built_in">limit</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;<span class="built_in">type</span>&gt; can have the two values:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - <span class="string">"soft"</span> <span class="keyword">for</span> enforcing the soft limits</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - <span class="string">"hard"</span> <span class="keyword">for</span> enforcing hard limits</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;item&gt; can be one of the following:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - core - limits the core file size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - data - max data size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - fsize - maximum filesize (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - memlock - max locked-in-memory address space (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - nofile - max number of open file descriptors</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - rss - max resident <span class="built_in">set</span> size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - stack - max stack size (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - cpu - max CPU time (MIN)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - nproc - max number of processes</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - as - address space <span class="built_in">limit</span> (KB)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - maxlogins - max number of logins <span class="keyword">for</span> this user</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - maxsyslogins - max number of logins on the system</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - priority - the priority to run user process with</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - locks - max number of file locks the user can hold</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - sigpending - max number of pending signals</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - msgqueue - max memory used by POSIX message queues (bytes)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - nice - max nice priority allowed to raise to values: [-20, 19]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        - rtprio - max realtime priority</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">&lt;domain&gt;      &lt;<span class="built_in">type</span>&gt;  &lt;item&gt;         &lt;value&gt;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">*               soft    core            0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">*               hard    rss             10000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@student        hard    nproc           20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@faculty        soft    nproc           20</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@faculty        hard    nproc           50</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ftp             hard    nproc           0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">@student        -       maxlogins       4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> End of file</span></span><br><span class="line">*        hard    nofile           65536</span><br><span class="line">*        soft    nofile           65536</span><br></pre></td></tr></table></figure>

<p>其中含义如下：</p>
<ul>
<li>第一列表示域（domain）,可以使用用户名（root等），组名（以@开头）,通配置*和%，%可以用于%group参数。</li>
<li>第二列表示类型(type),值可以是soft或者hard</li>
<li>第三列表示项目(item),值可以是core, data, fsize, memlock, nofile, rss, stack, cpu, nproc, as, maxlogins, maxsyslogins, priority, locks, msgqueue, nie, rtprio。其中nofile(Number of Open File）就是文件打开数。</li>
<li>第四列表示值.</li>
</ul>
<h3 id="为什么有限制？"><a href="#为什么有限制？" class="headerlink" title="为什么有限制？"></a>为什么有限制？</h3><p>为什么Linux内核对文件句柄数、线程和进程的最大打开数进行了限制？以及如果我们把它调的太大，会产生什么样的后果？</p>
<p>原因1 - 资源问题：the operating system needs memory to manage each open file, and memory is a limited resource - especially on embedded systems.<br>原因2 - 安全问题：if there were no limits, a userland software would be able to create files endlessly until the server goes down.</p>
<p>What’s more? If the file descriptors are tcp sockets, etc, then you risk using up a large amount for the socket buffers and other kernel objects, this memory is not going to be swappable.</p>
<p>最主要的是资源问题，为防止某一单一进程打开过多文件描述符而耗尽系统资源，对进程打开文件数做了限制。</p>
<p>参考文献：</p>
<ol>
<li><a href="https://mp.weixin.qq.com/s?subscene=3&amp;__biz=MzU0MzQ5MDA0Mw==&amp;mid=2247484040&amp;idx=1&amp;sn=5eeb3b777ea9c47267fc829fb2482b83&amp;chksm=fb0be81ccc7c610a385c3505a2aebe8708e0509ffd06afb05773af7dc93fc770c91a91e5f630&amp;scene=7&amp;ascene=65&amp;devicetype=android-29&amp;version=3.0.25.1805&amp;nettype=cmnet&amp;abtest_cookie=AAACAA%3D%3D&amp;lang=zh_CN&amp;exportkey=AUf1cgx2bjxGWSfWCBZr%2FKc%3D&amp;pass_ticket=F7zZsG2WgI8Oq9V2kkVUJtftv2JEEeLyA%2FXz9j1Av8pU2wezBmwORCa7f74brprY&amp;wx_header=1&amp;platform=win" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?subscene=3&amp;__biz=MzU0MzQ5MDA0Mw==&amp;mid=2247484040&amp;idx=1&amp;sn=5eeb3b777ea9c47267fc829fb2482b83&amp;chksm=fb0be81ccc7c610a385c3505a2aebe8708e0509ffd06afb05773af7dc93fc770c91a91e5f630&amp;scene=7&amp;ascene=65&amp;devicetype=android-29&amp;version=3.0.25.1805&amp;nettype=cmnet&amp;abtest_cookie=AAACAA%3D%3D&amp;lang=zh_CN&amp;exportkey=AUf1cgx2bjxGWSfWCBZr%2FKc%3D&amp;pass_ticket=F7zZsG2WgI8Oq9V2kkVUJtftv2JEEeLyA%2FXz9j1Av8pU2wezBmwORCa7f74brprY&amp;wx_header=1&amp;platform=win</a> 文件句柄？文件描述符？傻傻分不清楚</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/06/Linux%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6/" data-id="ckd8njbhq0010tsp527za28gj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-入坑JavaCC" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/01/%E5%85%A5%E5%9D%91JavaCC/" class="article-date">
  <time datetime="2020-07-01T01:18:06.789Z" itemprop="datePublished">2020-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/01/%E5%85%A5%E5%9D%91JavaCC/">入坑JavaCC</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/01/%E5%85%A5%E5%9D%91JavaCC/" data-id="ckd8njbi0001wtsp537vzgtjj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Develop/">Develop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Maintenance/">Maintenance</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Test/">Test</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ClickHouse/" rel="tag">ClickHouse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataX/" rel="tag">DataX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flink/" rel="tag">Flink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Idea/" rel="tag">Idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/" rel="tag">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenTSDB/" rel="tag">OpenTSDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zeppelin/" rel="tag">Zeppelin</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ClickHouse/" style="font-size: 16.67px;">ClickHouse</a> <a href="/tags/DataX/" style="font-size: 10px;">DataX</a> <a href="/tags/Flink/" style="font-size: 13.33px;">Flink</a> <a href="/tags/Hive/" style="font-size: 10px;">Hive</a> <a href="/tags/Idea/" style="font-size: 10px;">Idea</a> <a href="/tags/Kafka/" style="font-size: 10px;">Kafka</a> <a href="/tags/OpenTSDB/" style="font-size: 20px;">OpenTSDB</a> <a href="/tags/Zeppelin/" style="font-size: 10px;">Zeppelin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/30/OpenTSDB%20UID%E7%94%9F%E6%88%90%E8%A7%84%E5%88%99/">OpenTSDB UID生成规则</a>
          </li>
        
          <li>
            <a href="/2020/07/29/OpenTSDB%20Salt%E7%94%9F%E6%88%90%E6%96%B9%E5%BC%8F/">OpenTSDB Salt值生成方式</a>
          </li>
        
          <li>
            <a href="/2020/07/23/OpenTSDB%E8%AE%BF%E9%97%AE%E5%BC%80%E5%90%AFKerberos%E6%9C%8D%E5%8A%A1%E7%9A%84Hbase/">OpenTSDB访问开启Kerberos服务的Hbase</a>
          </li>
        
          <li>
            <a href="/2020/07/22/Kerberos%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/">Kerberos使用记录</a>
          </li>
        
          <li>
            <a href="/2020/07/21/CDH5.16%E5%90%AF%E7%94%A8Kerberos/">CDH5.16中启用Kerberos</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 qiguoxiaosheng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>